<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
  <title>Mvgam on GAMbler</title>
  <link>https://ecogambler.netlify.app/tags/mvgam/</link>
  <description>Recent content in Mvgam on GAMbler</description>
  <generator>Hugo</generator>
  <language>en</language>
<copyright>© Nicholas J Clark (2024)</copyright>
<lastBuildDate>Fri, 06 Sep 2024 00:00:00 +0000</lastBuildDate>
<atom:link href="https://ecogambler.netlify.app/tags/mvgam/index.xml" rel="self" type="application/rss+xml" />
<item>
  <title>State-Space Vector Autoregressions in mvgam</title>
  <link>https://ecogambler.netlify.app/blog/vector-autoregressions/</link>
  <pubDate>Fri, 06 Sep 2024 00:00:00 +0000</pubDate>
<guid>https://ecogambler.netlify.app/blog/vector-autoregressions/</guid>
  <description>&lt;p&gt;&#xA;&lt;a href=&#34;https://otexts.com/fpp3/VAR.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Vector Autoregressions (VAR models)&lt;/a&gt;, also known in the ecological literature as &#xA;&lt;a href=&#34;https://atsa-es.github.io/MARSS/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Multivariate Autoregressions (MAR models)&lt;/a&gt;, are a class of Dynamic Linear Models that offer a principled way to model both delayed and contemporaneous interactions among sets of multiple time series. These models are widely used in econometrics and psychology, among other fields, where they can be analyzed to ask many interesting questions about &#xA;&lt;a href=&#34;https://www.jstor.org/stable/2951647&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;potential causality&lt;/a&gt;, &#xA;&lt;a href=&#34;https://www.r-econometrics.com/timeseries/irf/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;cascading temporal interaction effects&lt;/a&gt; or &#xA;&lt;a href=&#34;https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1890/0012-9615%282003%29073%5B0301%3AECSAEI%5D2.0.CO%3B2&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;community stability&lt;/a&gt;. A VAR(1) model, where temporal interactions among series can take place at a lag of one time step, is defined as:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$y_t \sim{MVNormal}(\alpha + A * y_{t-1}, \Sigma)$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;Where:&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;\(y_t\)&lt;/code&gt; is a vector of time series observations at time &lt;code&gt;\(t\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;\(\alpha\)&lt;/code&gt; is a vector of constants capturing the long-term means of each series in &lt;code&gt;\(y\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;\(A\)&lt;/code&gt; is a matrix of autoregressive coefficients estimating lagged dependence and cross-dependence between the elements of &lt;code&gt;\(y\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;\(\Sigma\)&lt;/code&gt; determines the spread (or flexibility) of the process and any contemporaneous correlations among time series errors&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Many R packages exist to estimate parameters of VARs, including the &#xA;&lt;a href=&#34;https://cran.r-project.org/web/packages/vars/index.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;vars&lt;/code&gt;&lt;/a&gt; and &#xA;&lt;a href=&#34;https://bsvars.github.io/bsvars/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;bsvars&lt;/code&gt;&lt;/a&gt; packages. However, as we can see from the model description above, the traditional VAR model makes two big assumptions: first, this model assumes that the time series being analyzed do not show any measurement error. This assumption may hold for certain types of time series that can be nearly perfectly measured, such as sales of items in a store with accurate digital sale tracking. But it is likely to be broken for the majority of series that are measured with imperfect detectors or with time-varying effort. This can be resolved if we instead refer to a &#xA;&lt;a href=&#34;chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://www.cs.unc.edu/~welch/kalman/media/pdf/Kalman1960.pdf&#34;&gt;State-Space&lt;/a&gt; representation of the model:&lt;/p&gt;&#xA;&lt;br&gt;&#xD;&#xA;&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/nicholasjclark/mvgam/refs/heads/master/vignettes/SS_model.svg&#34; alt=&#34;Illustration of a basic State-Space model, which assumes that  a latent dynamic process (X) can evolve independently from the way we take observations (Y) of that process&#34;&gt;&lt;/p&gt;&#xA;&lt;br&gt;&#xD;&#xA;&lt;p&gt;A State-Space model is convenient for dealing with many types of real-world time series because they can readily handle observation error, missing values and a broad range of dependency structures. For example, we can modify the VAR(1) described above to a State-Space representation using:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$y_t \sim{MVNormal}(\alpha + x_t, \Sigma_{obs})$$&lt;/code&gt;&#xA;&lt;code&gt;$$x_t \sim{MVNormal}(A * x_{t-1}, \Sigma_{process})$$&lt;/code&gt;&#xA;Where the observation time series &lt;code&gt;\(y_t\)&lt;/code&gt; are now considered to be noisy observations of some latent &lt;code&gt;\(process\)&lt;/code&gt; (labelled as &lt;code&gt;\(x_t\)&lt;/code&gt;) and it is this &lt;code&gt;\(process\)&lt;/code&gt; that evolves as a Vector Autoregression. The advantage of this model is that we can separately estimate process and observation errors (modelled using the two &lt;code&gt;\(\Sigma\)&lt;/code&gt; matrices). This type of formulation is available using the &#xA;&lt;a href=&#34;https://atsa-es.github.io/MARSS/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;MARSS&lt;/code&gt;&lt;/a&gt; package, which has a wonderfully detailed &#xA;&lt;a href=&#34;chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://cran.r-project.org/web/packages/MARSS/vignettes/UserGuide.pdf&#34;&gt;list of worked examples&lt;/a&gt; to showcase how flexible and useful these models are.&lt;/p&gt;&#xA;&lt;p&gt;But the above approach does not address the second major limitation of traditional VARS, which is that they assume that the observation series can be captured with a Gaussian observation model. This makes it difficult to fit VARs to many real-world time series such as counts of multiple species over time, time series of non-negative rates or proportions of customers that responded to a set of surveys. It turns out that this limitation is a much bigger issue when it comes to fitting VARs to real-world data. At the time of writing I could not find a single R package that makes these models accessible, apart from my &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;mvgam&lt;/code&gt;&lt;/a&gt; package. Given that the question of how to fit time series models to non-Gaussian observations comes up &#xA;&lt;a href=&#34;https://stats.stackexchange.com/questions/161617/software-or-workarounds-for-vector-autoregression-on-count-data&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;again&lt;/a&gt; and &#xA;&lt;a href=&#34;https://stats.stackexchange.com/questions/47204/how-to-regress-a-time-series-of-proportions&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;again&lt;/a&gt; and &#xA;&lt;a href=&#34;https://stats.stackexchange.com/questions/244660/modeling-multivariate-time-series-count-data-in-r&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;again&lt;/a&gt; (and &#xA;&lt;a href=&#34;https://stats.stackexchange.com/questions/70182/time-series-dynamic-poisson-regression&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;again&lt;/a&gt;), often with unsatisfying answers, this post will demonstrate how the &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;mvgam&lt;/code&gt;&lt;/a&gt; package can fill this gap. Herein I will show how the package can be used to fit complex multivariate autoregressive models to non-Gaussian time series and how to interrogate the models to ask insightful questions about temporal interactions, variance decompositions and community stability.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;environment-setup&#34;&gt;Environment setup&#xA;  &lt;a href=&#34;#environment-setup&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;This tutorial relies on the following packages (note that &#xA;&lt;a href=&#34;https://github.com/nicholasjclark/mvgam/tree/master&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;mvgam&lt;/code&gt; version 1.1.3 or higher&lt;/a&gt; is required to carry out these analyses):&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(mvgam)           &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Fit, interrogate and forecast DGAMs&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(tidyverse)       &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Tidy and flexible data manipulation&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(ggplot2)         &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Flexible plotting&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(tidybayes)       &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Graceful plotting of Bayesian posterior estimates&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(farver)          &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Colour space manipulations&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;I also define a few plotting utilities to streamline my analysis workflow&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme_set&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme_classic&lt;/span&gt;(base_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;15&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        base_family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;serif&amp;#39;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;myhist &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;...&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_histogram&lt;/span&gt;(col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;white&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                 fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;#B97C7C&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;...&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;hist_theme &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme&lt;/span&gt;(axis.line.y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;element_blank&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        axis.ticks.y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;element_blank&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        axis.text.y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;element_blank&lt;/span&gt;())&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;load-manipulate-and-plot-the-data&#34;&gt;Load, manipulate and plot the data&#xA;  &lt;a href=&#34;#load-manipulate-and-plot-the-data&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;We will work with a set of annual American kestrel (&lt;em&gt;Falco sparverius&lt;/em&gt;) abundance time series, which represent adjusted annual counts of this species taken in three adjacent regions of British Columbia, Canada. These data were collected annually, corrected for changes in observer coverage and detectability, and logged. They can be accessed in the &#xA;&lt;a href=&#34;https://atsa-es.github.io/MARSS/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;MARSS&lt;/code&gt;&lt;/a&gt; package&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;load&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;url&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;https://github.com/atsa-es/MARSS/raw/master/data/kestrel.rda&amp;#39;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;head&lt;/span&gt;(kestrel)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;##      Year British.Columbia Alberta Saskatchewan&#xD;&#xA;## [1,] 1969            0.754   0.460        0.000&#xD;&#xA;## [2,] 1970            0.673   0.899        0.192&#xD;&#xA;## [3,] 1971            0.734   1.133        0.280&#xD;&#xA;## [4,] 1972            0.589   0.528        0.386&#xD;&#xA;## [5,] 1973            1.405   0.789        0.451&#xD;&#xA;## [6,] 1974            0.624   0.528        0.234&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Arrange the data into a &lt;code&gt;data.frame&lt;/code&gt; that spreads the time series observations into a &amp;rsquo;long&amp;rsquo; format, &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/articles/data_in_mvgam.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;which is required for &lt;code&gt;mvgam&lt;/code&gt; modelling&lt;/a&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;regions &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;BC&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;Alb&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;Sask&amp;#34;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;model_data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;do.call&lt;/span&gt;(rbind,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                      &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lapply&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq_along&lt;/span&gt;(regions),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data.frame&lt;/span&gt;(year &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; kestrel[, &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;],&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Reverse the logging so that we deal directly &lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# with the detection-adjusted counts&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             adj_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exp&lt;/span&gt;(kestrel[, &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; x]),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             region &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; regions[x])})) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Add series and time indicators for mvgam modelling&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.factor&lt;/span&gt;(region),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; year)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Inspect the time series data structure&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;head&lt;/span&gt;(model_data)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;##   year adj_count region series time&#xD;&#xA;## 1 1969  2.125485     BC     BC 1969&#xD;&#xA;## 2 1970  1.960109     BC     BC 1970&#xD;&#xA;## 3 1971  2.083398     BC     BC 1971&#xD;&#xA;## 4 1972  1.802185     BC     BC 1972&#xD;&#xA;## 5 1973  4.075527     BC     BC 1973&#xD;&#xA;## 6 1974  1.866379     BC     BC 1974&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;glimpse&lt;/span&gt;(model_data)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Rows: 120&#xD;&#xA;## Columns: 5&#xD;&#xA;## $ year      &amp;lt;dbl&amp;gt; 1969, 1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, …&#xD;&#xA;## $ adj_count &amp;lt;dbl&amp;gt; 2.125485, 1.960109, 2.083398, 1.802185, 4.075527, 1.866379, …&#xD;&#xA;## $ region    &amp;lt;chr&amp;gt; &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, &amp;#34;BC&amp;#34;, …&#xD;&#xA;## $ series    &amp;lt;fct&amp;gt; BC, BC, BC, BC, BC, BC, BC, BC, BC, BC, BC, BC, BC, BC, BC, …&#xD;&#xA;## $ time      &amp;lt;dbl&amp;gt; 1969, 1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, …&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;levels&lt;/span&gt;(model_data&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] &amp;#34;Alb&amp;#34;  &amp;#34;BC&amp;#34;   &amp;#34;Sask&amp;#34;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Plot all three the time series together using &lt;code&gt;mvgam&lt;/code&gt;&amp;rsquo;s &lt;code&gt;plot_mvgam_series()&lt;/code&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; model_data,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;adj_count&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;all&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-8-1.png&#34; alt=&#34;American kestrel adjusted count time series in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Now plot some additional features, including the empirical CDF and estimated autocorrelation functions, for just one series at a time&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; model_data,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;adj_count&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-10-1.png&#34; alt=&#34;American kestrel time series features in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; model_data,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;adj_count&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-12-1.png&#34; alt=&#34;American kestrel time series features in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;These latter plots make it immediately apparent that our outcome variable, i.e. the adjusted counts of kestrels in each region over time, only takes on non-negative real numbers:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(model_data,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; adj_count)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;myhist&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Adjusted count&amp;#39;&lt;/span&gt;, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;hist_theme&lt;/span&gt;()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-13-1.png&#34; alt=&#34;Empirical distribution of American kestrel adjusted counts&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;build-a-state-space-var1-model&#34;&gt;Build a State-Space VAR(1) model&#xA;  &lt;a href=&#34;#build-a-state-space-var1-model&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;Fitting a multivariate time series model to these adjusted counts is not easy using existing R packages. We&amp;rsquo;d almost certainly have to log-transform the outcome and hope that we don&amp;rsquo;t lose too much inferential ability in doing so. But, &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;as I&amp;rsquo;ve shown in other blogposts on this site&lt;/a&gt;, there is a better and simpler way to respect the nature of these observations using &lt;code&gt;mvgam&lt;/code&gt;. Here we will consider a State-Space model that uses a latent Vector Autoregression as a VAR(1) process. This is done by taking advantage of two key features of the workhorse &lt;code&gt;mvgam()&lt;/code&gt; function: First, we can use the &lt;code&gt;trend_formula&lt;/code&gt; argument to specify that we want a State-Space model. And second, we can use the &lt;code&gt;trend_model&lt;/code&gt; argument to specify that we want the latent process to evolve as a Vector Autoregression of order 1. The &#xA;&lt;a href=&#34;https://github.com/nicholasjclark/mvgam/raw/master/misc/mvgam_cheatsheet.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;mvgam&lt;/code&gt; cheatsheet&lt;/a&gt; goes into some detail about how each of these arguments work, but your best bet is to read the extensive documentation in &lt;code&gt;?mvgam::mvgam&lt;/code&gt; to fully understand how these models can be constructed. &lt;code&gt;mvgam&lt;/code&gt; also takes advantage of &#xA;&lt;a href=&#34;https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a major development in Bayesian VAR modelling, originally published by Sarah Heaps, that enforces stationarity through a principled prior on the autoregressive coefficients&lt;/a&gt;. This is extremely helpful for ensuring that we find well-behaving models that don&amp;rsquo;t give nonsensical and unwieldy forecasts where the forecast variance grows without bound. Given that the average counts of these series seems to vary across regions, we will also want to include region-level intercepts in the process model. And finally, given the nature of the response variable (non-negative real values), a suitable observation family would be the Gamma distribution. First we should inspect default prior distributions for the stochastic parameters involved in our model:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;def_priors &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;get_mvgam_priors&lt;/span&gt;(adj_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;-1&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               trend_formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; region,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               trend_model &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;VAR&lt;/span&gt;(cor &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; model_data,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;Gamma&lt;/span&gt;())&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;def_priors[, &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;]&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;##                                           param_info&#xD;&#xA;## 1                                        (Intercept)&#xD;&#xA;## 2                                   process error sd&#xD;&#xA;## 3           diagonal autocorrelation population mean&#xD;&#xA;## 4       off-diagonal autocorrelation population mean&#xD;&#xA;## 5       diagonal autocorrelation population variance&#xD;&#xA;## 6   off-diagonal autocorrelation population variance&#xD;&#xA;## 7      shape1 for diagonal autocorrelation precision&#xD;&#xA;## 8  shape1 for off-diagonal autocorrelation precision&#xD;&#xA;## 9      shape2 for diagonal autocorrelation precision&#xD;&#xA;## 10 shape2 for off-diagonal autocorrelation precision&#xD;&#xA;## 11                             Gamma shape parameter&#xD;&#xA;## 12                         (Intercept) for the trend&#xD;&#xA;## 13                             regionBC fixed effect&#xD;&#xA;## 14                           regionSask fixed effect&#xD;&#xA;##                                      prior&#xD;&#xA;## 1    (Intercept) ~ student_t(3, 0.6, 2.5);&#xD;&#xA;## 2         sigma ~ inv_gamma(1.418, 0.452);&#xD;&#xA;## 3                               es[1] = 0;&#xD;&#xA;## 4                               es[2] = 0;&#xD;&#xA;## 5                     fs[1] = sqrt(0.455);&#xD;&#xA;## 6                     fs[2] = sqrt(0.455);&#xD;&#xA;## 7                           gs[1] = 1.365;&#xD;&#xA;## 8                           gs[2] = 1.365;&#xD;&#xA;## 9                        hs[1] = 0.071175;&#xD;&#xA;## 10                       hs[2] = 0.071175;&#xD;&#xA;## 11              shape ~ gamma(0.01, 0.01);&#xD;&#xA;## 12 (Intercept)_trend ~ student_t(3, 0, 2);&#xD;&#xA;## 13    regionBC_trend ~ student_t(3, 0, 2);&#xD;&#xA;## 14  regionSask_trend ~ student_t(3, 0, 2);&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The priors for regression coefficients (&lt;code&gt;(Intercept)_trend&lt;/code&gt;, &lt;code&gt;regionBC_trend&lt;/code&gt; and &lt;code&gt;regionsSask_trend&lt;/code&gt;) and for the process variances (&lt;code&gt;sigma&lt;/code&gt;, which represent the diagonals of the process error matrix &lt;code&gt;\(\Sigma_{process}\)&lt;/code&gt;) are by default set to be quite vague. It is generally good practice to update these using domain knowledge if you want a model that is well-behaved and computationally efficient. Given that the adjusted counts are fairly small and that the Gamma distribution in &lt;code&gt;mvgam&lt;/code&gt; uses a log-link function, we don&amp;rsquo;t expect massive effect sizes in the linear predictor so a more suitable priors for the regression coefficients would be Standard Normal (i.e. &lt;code&gt;\(\beta \sim Normal(0, 1)\)&lt;/code&gt;). We can also change the default half-T prior on the process variances to an Exponential prior that places less belief on extremely large variances. We will leave the priors for the Gamma shape parameter and for the autoregressive partial autocorrelations (which are described in detail by &#xA;&lt;a href=&#34;https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Sarah Heaps in her wonderful VAR stationarity paper&lt;/a&gt;) as default. So our first model to consider is:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;varmod &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvgam&lt;/span&gt;(&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Observation formula, empty to only consider the Gamma observation process&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; adj_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;-1&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Process model formula that includes regional intercepts &lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  trend_formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; region,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# A VAR(1) dynamic process with fully parameterized covariance matrix Sigma&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  trend_model &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;VAR&lt;/span&gt;(cor &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Modified prior distributions using brms::prior()&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  priors &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;std_normal&lt;/span&gt;(), class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; Intercept_trend),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;std_normal&lt;/span&gt;(), class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; b),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exponential&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;2.5&lt;/span&gt;), class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; sigma)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# The time series data in &amp;#39;long&amp;#39; format&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; model_data,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# A Gamma observation family&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;Gamma&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Forcing all three series to share the same Gamma shape parameter&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  share_obs_params &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Stan control arguments&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  adapt_delta &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.95&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  burnin &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1000&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  samples &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1000&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  silent &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;model-diagnostics-and-inferences&#34;&gt;Model diagnostics and inferences&#xA;  &lt;a href=&#34;#model-diagnostics-and-inferences&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;This model only takes a few seconds to fit four parallel Hamiltonian Monte Carlo chains, though we do get some minor warnings about a few Hamiltonian Monte Carlo divergences which I have mostly mitigated by setting &lt;code&gt;adapt_delta = 0.95&lt;/code&gt;:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;summary&lt;/span&gt;(varmod)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## GAM observation formula:&#xD;&#xA;## adj_count ~ 1&#xD;&#xA;## &#xD;&#xA;## GAM process formula:&#xD;&#xA;## ~region&#xD;&#xA;## &#xD;&#xA;## Family:&#xD;&#xA;## Gamma&#xD;&#xA;## &#xD;&#xA;## Link function:&#xD;&#xA;## log&#xD;&#xA;## &#xD;&#xA;## Trend model:&#xD;&#xA;## VAR(cor = TRUE)&#xD;&#xA;## &#xD;&#xA;## &#xD;&#xA;## N process models:&#xD;&#xA;## 3 &#xD;&#xA;## &#xD;&#xA;## N series:&#xD;&#xA;## 3 &#xD;&#xA;## &#xD;&#xA;## N timepoints:&#xD;&#xA;## 40 &#xD;&#xA;## &#xD;&#xA;## Status:&#xD;&#xA;## Fitted using Stan &#xD;&#xA;## 4 chains, each with iter = 2000; warmup = 1000; thin = 1 &#xD;&#xA;## Total post-warmup draws = 4000&#xD;&#xA;## &#xD;&#xA;## &#xD;&#xA;## Observation shape parameter estimates:&#xD;&#xA;##       2.5% 50% 97.5% Rhat n_eff&#xD;&#xA;## shape   21  33    58    1   500&#xD;&#xA;## &#xD;&#xA;## GAM observation model coefficient (beta) estimates:&#xD;&#xA;##             2.5% 50% 97.5% Rhat n_eff&#xD;&#xA;## (Intercept)    0   0     0  NaN   NaN&#xD;&#xA;## &#xD;&#xA;## Process model VAR parameter estimates:&#xD;&#xA;##           2.5%    50% 97.5% Rhat n_eff&#xD;&#xA;## A[1,1]  0.0014  0.570  0.98 1.01   902&#xD;&#xA;## A[1,2] -0.5200 -0.040  0.26 1.01   701&#xD;&#xA;## A[1,3] -0.0930  0.560  2.10 1.00   407&#xD;&#xA;## A[2,1] -0.2300  0.310  1.30 1.01   753&#xD;&#xA;## A[2,2] -0.5100  0.420  0.85 1.01   545&#xD;&#xA;## A[2,3] -0.2900  0.690  2.80 1.00   505&#xD;&#xA;## A[3,1] -0.1000  0.110  0.55 1.00   880&#xD;&#xA;## A[3,2] -0.1800  0.033  0.23 1.01   586&#xD;&#xA;## A[3,3]  0.1400  0.650  1.10 1.01   713&#xD;&#xA;## &#xD;&#xA;## Process error parameter estimates:&#xD;&#xA;##               2.5%      50% 97.5% Rhat n_eff&#xD;&#xA;## Sigma[1,1]  0.0045  0.02200 0.058 1.01   461&#xD;&#xA;## Sigma[1,2] -0.0077  0.00880 0.033 1.00  1465&#xD;&#xA;## Sigma[1,3] -0.0110 -0.00045 0.008 1.00  1207&#xD;&#xA;## Sigma[2,1] -0.0077  0.00880 0.033 1.00  1465&#xD;&#xA;## Sigma[2,2]  0.0180  0.04800 0.100 1.00   886&#xD;&#xA;## Sigma[2,3] -0.0062  0.00460 0.019 1.00  1399&#xD;&#xA;## Sigma[3,1] -0.0110 -0.00045 0.008 1.00  1207&#xD;&#xA;## Sigma[3,2] -0.0062  0.00460 0.019 1.00  1399&#xD;&#xA;## Sigma[3,3]  0.0012  0.00530 0.021 1.00   340&#xD;&#xA;## &#xD;&#xA;## GAM process model coefficient (beta) estimates:&#xD;&#xA;##                    2.5%   50% 97.5% Rhat n_eff&#xD;&#xA;## (Intercept)_trend  0.40  0.70  0.95    1  1732&#xD;&#xA;## regionBC_trend    -0.12  0.15  0.37    1  2606&#xD;&#xA;## regionSask_trend  -0.54 -0.38 -0.21    1  1778&#xD;&#xA;## &#xD;&#xA;## Stan MCMC diagnostics:&#xD;&#xA;## ✔ No issues with effective samples per iteration&#xD;&#xA;## ✔ Rhat looks good for all parameters&#xD;&#xA;## ✔ No issues with divergences&#xD;&#xA;## ✔ No issues with maximum tree depth&#xD;&#xA;## &#xD;&#xA;## Samples were drawn using sampling(hmc). For each parameter, n_eff is a&#xD;&#xA;##   crude measure of effective sample size, and Rhat is the potential scale&#xD;&#xA;##   reduction factor on split MCMC chains (at convergence, Rhat = 1)&#xD;&#xA;## &#xD;&#xA;## Use how_to_cite() to get started describing this model&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We can inspect posterior estimates for some of the key parameters using &lt;code&gt;bayesplot&lt;/code&gt; functionality. For State-Space models, it is particularly recommended to inspect estimates for process and observation scale parameters (labelled as &lt;code&gt;sigma&lt;/code&gt; and &lt;code&gt;shape&lt;/code&gt; in the model&amp;rsquo;s MCMC output):&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mcmc_plot&lt;/span&gt;(varmod,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          variable &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;sigma&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          regex &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;trace&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-17-1.png&#34; alt=&#34;mvgam posterior estimates using bayesplot&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mcmc_plot&lt;/span&gt;(varmod,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          variable &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;shape&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;trace&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-18-1.png&#34; alt=&#34;mvgam posterior estimates using bayesplot&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Looking at possible coupling between these estimates is also a good idea, which you can do with the &lt;code&gt;pairs()&lt;/code&gt; function:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;pairs&lt;/span&gt;(varmod,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      variable &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;shape&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;sigma&amp;#39;&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      regex &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      off_diag_args &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;list&lt;/span&gt;(size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                           alpha &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.5&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-19-1.png&#34; alt=&#34;mvgam posterior pairs plots&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Overall these estimates are quite stable and well-behaved. We can also inspect estimates for any linear predictor effects (in both the process and observation models) using &lt;code&gt;conditional_effects()&lt;/code&gt;, which makes use of the wonderful &#xA;&lt;a href=&#34;https://marginaleffects.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;marginaleffects&lt;/code&gt;&lt;/a&gt; package (see &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/interpreting-gams/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;this post on interpreting Generalized Additive Models using &lt;code&gt;marginaleffects&lt;/code&gt;&lt;/a&gt; for a glimpse into the full power of this package). Since we only have the varying intercepts as regressors in our model, we only get one plot from this call:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;conditional_effects&lt;/span&gt;(varmod)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-20-1.png&#34; alt=&#34;mvgam conditional_effects plots&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;By default &lt;code&gt;conditional_effects()&lt;/code&gt; will return predictions on the response scale (i.e. considering the full uncertainty in posterior predictions). But we can also plot these on the link or expectation scales if we wish:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;conditional_effects&lt;/span&gt;(varmod,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;link&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-21-1.png&#34; alt=&#34;mvgam posterior pairs plots&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Posterior predictive checks are also useful for interrogating a Bayesian model. &lt;code&gt;mvgam&lt;/code&gt; offers multiple ways to do this. First we can compute unconditional posterior predictive checks, which integrate over the possible (stable) temporal states that &lt;em&gt;could have&lt;/em&gt; been encountered for each series. In other words, these plots show us the types of predictions that we might make if we had no observations to inform the states of the latent VAR(1) process:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;pp_check&lt;/span&gt;(varmod,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;dens_overlay_grouped&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         group &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;region&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         ndraws &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;50&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-22-1.png&#34; alt=&#34;mvgam posterior predictive checks&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Obviously these prediction densities are more variable than the actual observation densities. But the main shapes seem to have been reasonably well captured. &lt;code&gt;mvgam&lt;/code&gt; can also create conditional posterior predictive checks, using the actual latent temporal states that were estimated when the model conditioned on the observed data:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ppc&lt;/span&gt;(varmod,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;density&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-24-1.png&#34; alt=&#34;mvgam posterior predictive checks&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ppc&lt;/span&gt;(varmod,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;density&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-26-1.png&#34; alt=&#34;mvgam posterior predictive checks&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ppc&lt;/span&gt;(varmod,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;density&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-28-1.png&#34; alt=&#34;mvgam posterior predictive checks&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;These plots match the data more closely, which is expected when using a flexible autoregressive process to capture the unobserved dynamics. Next we can compute and plot probabilistic conditional hindcasts for each series:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;hcs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;hindcast&lt;/span&gt;(varmod)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(hcs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-31-1.png&#34; alt=&#34;mvgam probabilistic hindcasts&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(hcs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-33-1.png&#34; alt=&#34;mvgam probabilistic hindcasts&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(hcs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-35-1.png&#34; alt=&#34;mvgam probabilistic hindcasts&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;model-expansion&#34;&gt;Model expansion&#xA;  &lt;a href=&#34;#model-expansion&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;Given the subtle variations in the shapes of these observed distributions for each series, there may be support for fitting an equivalent model that allows the Gamma shape parameters to vary among series. Let&amp;rsquo;s fit a second model that allows this:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;varmod2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvgam&lt;/span&gt;(&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Observation formula, empty to only consider the Gamma observation process&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; adj_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;-1&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Process model formula that includes regional intercepts &lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  trend_formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; region,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# A VAR(1) dynamic process with fully parameterized covariance matrix Sigma&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  trend_model &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;VAR&lt;/span&gt;(cor &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Modified prior distributions using brms::prior()&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  priors &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;std_normal&lt;/span&gt;(), class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; Intercept_trend),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;std_normal&lt;/span&gt;(), class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; b),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exponential&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;2.5&lt;/span&gt;), class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; sigma)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# The time series data in &amp;#39;long&amp;#39; format&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; model_data,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# A Gamma observation family&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;Gamma&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Varying Gamma shape parameters per series&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  share_obs_params &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Stan control arguments&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  adapt_delta &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.95&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  burnin &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1000&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  samples &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1000&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  silent &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;This model also fits well and encounters few sampling issues&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;summary&lt;/span&gt;(varmod2)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## GAM observation formula:&#xD;&#xA;## adj_count ~ 1&#xD;&#xA;## &#xD;&#xA;## GAM process formula:&#xD;&#xA;## ~region&#xD;&#xA;## &#xD;&#xA;## Family:&#xD;&#xA;## Gamma&#xD;&#xA;## &#xD;&#xA;## Link function:&#xD;&#xA;## log&#xD;&#xA;## &#xD;&#xA;## Trend model:&#xD;&#xA;## VAR(cor = TRUE)&#xD;&#xA;## &#xD;&#xA;## &#xD;&#xA;## N process models:&#xD;&#xA;## 3 &#xD;&#xA;## &#xD;&#xA;## N series:&#xD;&#xA;## 3 &#xD;&#xA;## &#xD;&#xA;## N timepoints:&#xD;&#xA;## 40 &#xD;&#xA;## &#xD;&#xA;## Status:&#xD;&#xA;## Fitted using Stan &#xD;&#xA;## 4 chains, each with iter = 2000; warmup = 1000; thin = 1 &#xD;&#xA;## Total post-warmup draws = 4000&#xD;&#xA;## &#xD;&#xA;## &#xD;&#xA;## Observation shape parameter estimates:&#xD;&#xA;##          2.5% 50% 97.5% Rhat n_eff&#xD;&#xA;## shape[1]   12  26   120 1.01   371&#xD;&#xA;## shape[2]   13  35   190 1.01   301&#xD;&#xA;## shape[3]   21  39   100 1.00   493&#xD;&#xA;## &#xD;&#xA;## GAM observation model coefficient (beta) estimates:&#xD;&#xA;##             2.5% 50% 97.5% Rhat n_eff&#xD;&#xA;## (Intercept)    0   0     0  NaN   NaN&#xD;&#xA;## &#xD;&#xA;## Process model VAR parameter estimates:&#xD;&#xA;##          2.5%     50% 97.5% Rhat n_eff&#xD;&#xA;## A[1,1] -0.046  0.5600  1.00 1.00   899&#xD;&#xA;## A[1,2] -0.430 -0.0089  0.26 1.00  1147&#xD;&#xA;## A[1,3] -0.090  0.4200  1.60 1.01   796&#xD;&#xA;## A[2,1] -0.260  0.3900  2.30 1.01   376&#xD;&#xA;## A[2,2] -0.590  0.3800  0.85 1.01   495&#xD;&#xA;## A[2,3] -0.370  0.5600  2.60 1.01   704&#xD;&#xA;## A[3,1] -0.088  0.1700  1.10 1.01   312&#xD;&#xA;## A[3,2] -0.210  0.0440  0.28 1.00   741&#xD;&#xA;## A[3,3] -0.035  0.5700  0.98 1.00   693&#xD;&#xA;## &#xD;&#xA;## Process error parameter estimates:&#xD;&#xA;##               2.5%      50%  97.5% Rhat n_eff&#xD;&#xA;## Sigma[1,1]  0.0020  0.01800 0.0630 1.03   210&#xD;&#xA;## Sigma[1,2] -0.0078  0.00800 0.0320 1.00   930&#xD;&#xA;## Sigma[1,3] -0.0120 -0.00025 0.0083 1.00   938&#xD;&#xA;## Sigma[2,1] -0.0078  0.00800 0.0320 1.00   930&#xD;&#xA;## Sigma[2,2]  0.0180  0.05200 0.1100 1.00   673&#xD;&#xA;## Sigma[2,3] -0.0074  0.00440 0.0200 1.00  1326&#xD;&#xA;## Sigma[3,1] -0.0120 -0.00025 0.0083 1.00   938&#xD;&#xA;## Sigma[3,2] -0.0074  0.00440 0.0200 1.00  1326&#xD;&#xA;## Sigma[3,3]  0.0017  0.00740 0.0280 1.01   321&#xD;&#xA;## &#xD;&#xA;## GAM process model coefficient (beta) estimates:&#xD;&#xA;##                    2.5%   50% 97.5% Rhat n_eff&#xD;&#xA;## (Intercept)_trend  0.38  0.71  0.93    1  1358&#xD;&#xA;## regionBC_trend    -0.12  0.14  0.34    1  2081&#xD;&#xA;## regionSask_trend  -0.54 -0.40 -0.21    1  1216&#xD;&#xA;## &#xD;&#xA;## Stan MCMC diagnostics:&#xD;&#xA;## ✔ No issues with effective samples per iteration&#xD;&#xA;## ✔ Rhat looks good for all parameters&#xD;&#xA;## ✔ No issues with divergences&#xD;&#xA;## ✔ No issues with maximum tree depth&#xD;&#xA;## &#xD;&#xA;## Samples were drawn using sampling(hmc). For each parameter, n_eff is a&#xD;&#xA;##   crude measure of effective sample size, and Rhat is the potential scale&#xD;&#xA;##   reduction factor on split MCMC chains (at convergence, Rhat = 1)&#xD;&#xA;## &#xD;&#xA;## Use how_to_cite() to get started describing this model&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;But now we have three shape parameters to inspect:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mcmc_plot&lt;/span&gt;(varmod2,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          variable &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;shape&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          regex &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;trace&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-38-1.png&#34; alt=&#34;mvgam posterior estimates using bayesplot&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;The unconditional posterior predictive checks look slightly better for the first and third series (&lt;code&gt;&#39;Alb&#39;&lt;/code&gt; and &lt;code&gt;&#39;Sask&lt;/code&gt;&amp;rsquo;):&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;pp_check&lt;/span&gt;(varmod2,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;dens_overlay_grouped&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         group &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;region&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         ndraws &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;50&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-39-1.png&#34; alt=&#34;mvgam posterior predictive checks&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;And so do the probabilistic conditional hindcasts:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;hcs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;hindcast&lt;/span&gt;(varmod2)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(hcs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-42-1.png&#34; alt=&#34;mvgam probabilistic hindcasts&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(hcs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-44-1.png&#34; alt=&#34;mvgam probabilistic hindcasts&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(hcs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-46-1.png&#34; alt=&#34;mvgam probabilistic hindcasts&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;model-comparison-with-loo_compare&#34;&gt;Model comparison with &lt;code&gt;loo_compare()&lt;/code&gt;&#xA;  &lt;a href=&#34;#model-comparison-with-loo_compare&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;The plots for the second model look &lt;em&gt;slightly&lt;/em&gt; better for some of the series, but of course this is a more complex model so we may expect that. Generally we may want to select among these two competing models, and the approximate leave-one-out cross-validation routines provided by the &#xA;&lt;a href=&#34;https://mc-stan.org/loo/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;loo&lt;/code&gt;&lt;/a&gt; package allow us to do this. We simply call &lt;code&gt;loo_compare()&lt;/code&gt; and feed in the set of models that we&amp;rsquo;d like to compare:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;loo_compare&lt;/span&gt;(varmod, varmod2)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;##         elpd_diff se_diff&#xD;&#xA;## varmod2       0.0     0.0&#xD;&#xA;## varmod       -3.6     1.9&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The second model has slightly but consistently higher leave-one-out expected log predictive densities than the first model, so it appears to be slightly favoured. But of course we may wish to use other forms of model comparison, such as &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/articles/forecast_evaluation.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;computing proper scoring rules for out-of-sample probabilistic forecasts&lt;/a&gt;. But for simplicity we will stick with the second model for further interrogation.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;interrogating-var1-models-in-mvgam&#34;&gt;Interrogating VAR(1) models in &lt;code&gt;mvgam&lt;/code&gt;&#xA;  &lt;a href=&#34;#interrogating-var1-models-in-mvgam&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;There are &lt;em&gt;many&lt;/em&gt; useful questions that can be approached using VAR models, which I eluded to at the beginning of this post. &lt;code&gt;mvgam&lt;/code&gt; has support for a growing number of investigations that can be performed using built-in functions, and this section will highlight some of those functionalities.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;inspecting-ar-coefficient-and-covariance-estimates&#34;&gt;Inspecting AR coefficient and covariance estimates&#xA;  &lt;a href=&#34;#inspecting-ar-coefficient-and-covariance-estimates&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;One of the first things we might want to do with a VAR(1) model is to inspect the &lt;code&gt;\(A\)&lt;/code&gt; matrix, which includes the autoregressive coefficients that estimate lagged dependence and cross-dependence between the elements of the latent process model. By default &lt;code&gt;bayesplot&lt;/code&gt; will plot these in the wrong order, so a bit of rearranging of the parameter estimates is needed to show the full matrix of estimates:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;A_pars &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NA&lt;/span&gt;, nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;, ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(j &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    A_pars[i, j] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;paste0&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;A[&amp;#39;&lt;/span&gt;, i, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;,&amp;#39;&lt;/span&gt;, j, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;]&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mcmc_plot&lt;/span&gt;(varmod2,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          variable &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.vector&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;t&lt;/span&gt;(A_pars)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;hist&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_vline&lt;/span&gt;(xintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;white&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             linewidth &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_vline&lt;/span&gt;(xintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             linewidth &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-49-1.png&#34; alt=&#34;mvgam vector autoregressive coefficient inspection&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;This plot makes it clear that there is broad posterior support for positive interactions among the three latent processes. For example, the estimates in &lt;code&gt;A[2,3]&lt;/code&gt; capture how an &lt;em&gt;increase&lt;/em&gt; in the process for series 3 (&lt;code&gt;&#39;Sask&#39;&lt;/code&gt;) at time &lt;code&gt;\(t\)&lt;/code&gt; is expected to impact the process for series 2 (&lt;code&gt;&#39;BC&#39;&lt;/code&gt;) at time  &lt;code&gt;\(t+1\)&lt;/code&gt;. This might make biological sense as it could be possible that increasing populations in one region lead to subsequent increases in other regions due to dispersal events.&lt;/p&gt;&#xA;&lt;p&gt;We might also want to look at evidence for contemporaneous associations among these processes, which are captured in the covariance matrix &lt;code&gt;\(\Sigma_{process}\)&lt;/code&gt;. The same rearrangement of parameters is needed to get these in the right order:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Sigma_pars &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NA&lt;/span&gt;, nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;, ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(j &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    Sigma_pars[i, j] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;paste0&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Sigma[&amp;#39;&lt;/span&gt;, i, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;,&amp;#39;&lt;/span&gt;, j, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;]&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mcmc_plot&lt;/span&gt;(varmod2,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          variable &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.vector&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;t&lt;/span&gt;(Sigma_pars)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;hist&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_vline&lt;/span&gt;(xintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;white&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             linewidth &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_vline&lt;/span&gt;(xintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             linewidth &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-50-1.png&#34; alt=&#34;mvgam vector autoregressive covariance inspection&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Again we see many positive covariances which suggests that these processes are not evolving independently, but are rather likely to be co-responding to some broader phenomena&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;impulse-response-functions&#34;&gt;Impulse Response Functions&#xA;  &lt;a href=&#34;#impulse-response-functions&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;Generalized or Orthogonalized Impulse Response Functions (IRFs) can be computed using the posterior estimates of Vector Autoregressive parameters from &lt;code&gt;mvgam&lt;/code&gt; models fitted with &lt;code&gt;VAR()&lt;/code&gt; trend models. This function runs a simulation whereby a positive &amp;ldquo;shock&amp;rdquo; is generated for a target process at time &lt;code&gt;\(t = 0\)&lt;/code&gt;. All else remaining stable, it then monitors how each of the remaining processes in the latent VAR would be expected to respond over the forecast horizon &lt;code&gt;\(h\)&lt;/code&gt;. The function computes IRFs for all processes in the object and returns them in an array that can be plotted using the &lt;code&gt;S3&lt;/code&gt; &lt;code&gt;plot()&lt;/code&gt; function. Here we will use the generalized IRF, which makes no assumptions about the order in which the series appear in the VAR process, and inspect how each process is expected to respond to a sudden, positive &lt;em&gt;pulse&lt;/em&gt; from the other processes over a horizon of 12 years.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;irfs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;irf&lt;/span&gt;(varmod2,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            h &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            orthogonal &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(irfs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-53-1.png&#34; alt=&#34;mvgam vector autoregressive impulse response functions&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(irfs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-55-1.png&#34; alt=&#34;mvgam vector autoregressive impulse response functions&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(irfs,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-57-1.png&#34; alt=&#34;mvgam vector autoregressive impulse response functions&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;These plots make it clear that, if one region experienced a temporary pulse in the number of American kestrels, we&amp;rsquo;d expect the remaining regions to show contemporaneous and/or subsequent increases over the following years. Moreover, we&amp;rsquo;d expect the effects of this pulse to reverberate for many years, thanks to the strong positive dependencies that are shown among all three series.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;forecast-error-variance-decompositions&#34;&gt;Forecast Error Variance Decompositions&#xA;  &lt;a href=&#34;#forecast-error-variance-decompositions&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;Using the same logic as above, we can inspect forecast error variance decompositions (FEVDs) for each process using the &lt;code&gt;fevd()&lt;/code&gt; function. This type of analysis asks how orthogonal shocks to all process in the system contribute to the variance of forecast uncertainty for a focal process over increasing horizons. In other words, the proportion of the forecast variance of each latent time series can be attributed to the effects of the other series in the VAR proces. FEVDs are useful because some shocks may not be expected to cause variations in the short-term but may cause longer-term fluctuations&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;fevds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;fevd&lt;/span&gt;(varmod2, h &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The &lt;code&gt;S3&lt;/code&gt; &lt;code&gt;plot()&lt;/code&gt; function for these objects returns a &lt;code&gt;ggplot&lt;/code&gt; object that shows the mean expected contribution to forecast error variance for each process in the VAR model:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(fevds) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;scale_fill_manual&lt;/span&gt;(values &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#DCBCBC&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#5C0000&amp;#34;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-59-1.png&#34; alt=&#34;mvgam vector autoregressive forecast error variance decompositions&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;This plot shows that the variance of forecast uncertainty for each process is initially dominated by contributions from that same process (i.e. self-dependent effects) but that effects from other processes become more important over increasing forecast horizons. Given what we saw from the IRF plots above, these long-term contributions from interactions among the processes makes sense.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;community-stability-metrics&#34;&gt;Community stability metrics&#xA;  &lt;a href=&#34;#community-stability-metrics&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;&lt;code&gt;mvgam&lt;/code&gt; can also calculate a range of community stability metrics, which can be used to assess how important inter-series dependencies are to the variability of a multivariate system and to ask how systems are expected to respond to environmental perturbations. The &lt;code&gt;stability()&lt;/code&gt; function computes a posterior distribution for the long-term stationary forecast distribution of the system, which&#xA;has mean &lt;code&gt;\(\mu_{\infty}\)&lt;/code&gt; and variance &lt;code&gt;\(\Sigma_{\infty}\)&lt;/code&gt;, to then calculate the following quantities:&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;code&gt;prop_int&lt;/code&gt;: Proportion of the volume of the stationary forecast distribution that is attributable to lagged interactions (i.e. how important are the autoregressive interaction coefficients in &lt;code&gt;\(A\)&lt;/code&gt; for explaining the shape of the stationary forecast distribution?): &lt;code&gt;\(det(A)^2\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;prop_int_adj&lt;/code&gt;: Same as &lt;code&gt;prop_int&lt;/code&gt; but scaled by the number of series &lt;code&gt;\(p\)&lt;/code&gt; to facilitate direct comparisons among systems with different numbers of interacting variables: &lt;code&gt;\(det(A)^{2/p}\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;prop_int_offdiag&lt;/code&gt;: Sensitivity of &lt;code&gt;prop_int&lt;/code&gt; to inter-series interactions (i.e. how important are the off-diagonals of the autoregressive coefficient matrix &lt;code&gt;\(A\)&lt;/code&gt; for shaping &lt;code&gt;prop_int&lt;/code&gt;?), calculated as the relative magnitude of the &lt;em&gt;off-diagonals&lt;/em&gt; in the partial derivative matrix: &lt;code&gt;\([2~det(A) (A^{-1})^T]\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;prop_int_diag&lt;/code&gt;: Sensitivity of &lt;code&gt;prop_int&lt;/code&gt; to intra-series interactions (i.e. how important are the&#xA;diagonals of the autoregressive coefficient matrix &lt;code&gt;\(A\)&lt;/code&gt; for shaping &lt;code&gt;prop_int&lt;/code&gt;?), calculated as the&#xA;relative magnitude of the &lt;em&gt;diagonals&lt;/em&gt; in the partial derivative matrix: &lt;code&gt;\([2~det(A) (A^{-1})^T]\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;prop_cov_offdiag&lt;/code&gt;: Sensitivity of &lt;code&gt;\(\Sigma_{\infty}\)&lt;/code&gt; to inter-series error correlations (i.e. how important are off-diagonal covariances in &lt;code&gt;\(\Sigma\)&lt;/code&gt; for shaping &lt;code&gt;\(\Sigma_{\infty}\)&lt;/code&gt;?), calculated as the relative magnitude of the &lt;em&gt;off-diagonals&lt;/em&gt; in the partial derivative matrix: &lt;code&gt;\([2~det(\Sigma_{\infty}) (\Sigma_{\infty}^{-1})^T]\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;prop_cov_diag&lt;/code&gt;: Sensitivity of &lt;code&gt;\(\Sigma_{\infty}\)&lt;/code&gt; to error variances (i.e. how important are diagonal variances in &lt;code&gt;\(\Sigma\)&lt;/code&gt; for shaping &lt;code&gt;\(\Sigma_{\infty}\)&lt;/code&gt;?), calculated as the relative magnitude of the &lt;em&gt;diagonals&lt;/em&gt; in the partial derivative matrix: &lt;code&gt;\([2~det(\Sigma_{\infty}) (\Sigma_{\infty}^{-1})^T]\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;reactivity&lt;/code&gt;: A measure of the degree to which the system moves away from a stable equilibrium following a perturbation. Values &lt;code&gt;&amp;gt; 0&lt;/code&gt; suggest the system is reactive, whereby a perturbation of the system in one period can be amplified into the next period. If &lt;code&gt;\(\sigma_{max}(A)\)&lt;/code&gt; is the largest singular value of &lt;code&gt;\(A\)&lt;/code&gt;, then reactivity is defined as: &lt;code&gt;\(log\sigma_{max}(A)\)&lt;/code&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;mean_return_rate&lt;/code&gt;: Asymptotic (long-term) return rate of the mean of the transition distribution to the stationary mean, calculated using the largest eigenvalue of the matrix &lt;code&gt;\(A\)&lt;/code&gt;: &lt;code&gt;\(max(\lambda_{A})\)&lt;/code&gt;. Lower values suggest greater stability of the system&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;var_return_rate&lt;/code&gt;: Asymptotic (long-term) return rate of the variance of the transition distribution to the stationary variance: &lt;code&gt;\(max(\lambda_{A \otimes{A}})\)&lt;/code&gt;. Again, lower values suggest greater stability of the system&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;metrics &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;stability&lt;/span&gt;(varmod2)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We can plot the posterior distribution of reactivity, which is &#xA;&lt;a href=&#34;https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/13-0996.1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;perhaps the most commonly calculated metric of ecological community stability&lt;/a&gt;, using &lt;code&gt;ggplot()&lt;/code&gt;:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(metrics, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; reactivity)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;myhist&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Reactivity&amp;#39;&lt;/span&gt;, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_vline&lt;/span&gt;(xintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;white&amp;#39;&lt;/span&gt;, linewidth &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2.5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_vline&lt;/span&gt;(xintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, linewidth &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1.5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;hist_theme&lt;/span&gt;()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-61-1.png&#34; alt=&#34;mvgam vector autoregressive community reactivity estimates&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;This system is considered to be &amp;ldquo;reactive&amp;rdquo;, whereby this index of the community&amp;rsquo;s short-term response to perturbations is mostly estimated to be &lt;code&gt;&amp;gt;0&lt;/code&gt;. Again this is not surprising, as both the &lt;code&gt;irf()&lt;/code&gt; and &lt;code&gt;fevd()&lt;/code&gt; plots show that the time series of adjusted counts in each region is highly dependent on time-lagged adjusted counts in other regions.&lt;/p&gt;&#xA;&lt;p&gt;Another useful question to ask from these metrics is what are the relative importances of the diagonals for determining the contributions of the &lt;code&gt;\(A\)&lt;/code&gt; and &lt;code&gt;\(\Sigma\)&lt;/code&gt; matrices to the shape of the stationary forecast distribution. In other words, we can decompose the contributions of these two matrices to the system&amp;rsquo;s stochastic equilibrium to understand which components (i.e. the self-dependence vs the inter-dependence effects) seem to have the biggest influences on the variability of the system. What follows is some rather long-winded code that will calculate and plot these contributions, using some helpful example code provided by &#xA;&lt;a href=&#34;https://www.mjskay.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Matthew Kay&lt;/a&gt;, maintainer of the &#xA;&lt;a href=&#34;https://mjskay.github.io/tidybayes/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;tidybayes&lt;/code&gt;&lt;/a&gt; package&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Gather posterior estimates of relative contributions for each matrix&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# into a tidy format for tidybayes plotting&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;prop_df &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rbind&lt;/span&gt;(metrics &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;select&lt;/span&gt;(prop_cov_diag,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  prop_cov_offdiag) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rename&lt;/span&gt;(diagonals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; prop_cov_diag,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  off_diagonals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; prop_cov_offdiag) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(.draw &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;n&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  group &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Process error (Sigma)&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    tidyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;pivot_longer&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(diagonals, off_diagonals),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        names_to &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Parameters&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        values_to &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;proportion&amp;#39;&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  metrics &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;select&lt;/span&gt;(prop_int_diag,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  prop_int_offdiag) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rename&lt;/span&gt;(diagonals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; prop_int_diag,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  off_diagonals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; prop_int_offdiag) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(.draw &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;n&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  group &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Autoregressive coefs (A)&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    tidyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;pivot_longer&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(diagonals, off_diagonals),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        names_to &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Parameters&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        values_to &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;proportion&amp;#39;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Calculate blurred color maps to graphically represent uncertainty&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# in these contributions&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&lt;/span&gt; .Machine&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;double.eps, length.out &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;200&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;df_curves &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; prop_df &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(cumulative_proportion &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;cumsum&lt;/span&gt;(proportion),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                .by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(.draw, group)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&amp;gt;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;reframe&lt;/span&gt;(&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;`P&lt;/span&gt;(value)` &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ecdf&lt;/span&gt;(cumulative_proportion)(p)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;*&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ecdf&lt;/span&gt;(cumulative_proportion &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&lt;/span&gt; proportion)(p),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    proportion &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; p,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    .by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(group, Parameters))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Set the colours and their labels&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;fill_scale &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;scale_fill_manual&lt;/span&gt;(values &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;lightgrey&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;fill_scale&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;train&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;diagonals&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;off_diagonals&amp;#34;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now we can plot these relative contributions in a way that aims to represent their associated posterior uncertainties&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;df_curves &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;summarise&lt;/span&gt;(color &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;encode_colour&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;`P&lt;/span&gt;(value)` &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%*%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                            &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;decode_colour&lt;/span&gt;(fill_scale&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;map&lt;/span&gt;(Parameters),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                          to &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;oklab&amp;#34;&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                          from &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;oklab&amp;#34;&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    .by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(group,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            proportion)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_blank&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; Parameters),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data.frame&lt;/span&gt;(Parameters &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;diagonals&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                              &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;off_diagonals&amp;#34;&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_slab&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; proportion,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; group,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;I&lt;/span&gt;(color),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                group &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NA&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    thickness &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    fill_type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;auto&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    side &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;both&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;stat_pointinterval&lt;/span&gt;(&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; group,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; proportion,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        group &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; Parameters),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; prop_df &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&amp;gt;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(proportion &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;cumsum&lt;/span&gt;(proportion),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             .by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(.draw, group)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&amp;gt;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(Parameters &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;off_diagonals&amp;#34;&lt;/span&gt;)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  fill_scale &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;scale_y_continuous&lt;/span&gt;(limits &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;coord_cartesian&lt;/span&gt;(expand &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Contribution to stationary distribution&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/vector-autoregressions/index_files/figure-html/unnamed-chunk-63-1.png&#34; alt=&#34;mvgam vector autoregressive community reactivity estimates&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;And there we have it. This plot demonstrates that, within the contribution of the &lt;code&gt;\(A\)&lt;/code&gt; matrix to the stable distribution, the off-diagonals (i.e. the lagged autoregressive interaction effects) play a sizable role. However, within the contribution of the &lt;code&gt;\(\Sigma\)&lt;/code&gt; matrix to the stable distribution, the diagonals (i.e. the process variances) are much more important than are the off-diagonal covariances. This gives us some insights into the relative importances of lagged vs contemporaneous &amp;ldquo;interactions&amp;rdquo; and can hopefully facilitate more in-depth ecological analyses.&lt;/p&gt;&#xA;&lt;p&gt;Also, although we haven&amp;rsquo;t covered it in this example, there is of course no reason why you cannot include complex covariate effects in either the process or observation models. Indeed, &lt;code&gt;mvgam()&lt;/code&gt; can readily handle a wide range of effects including multidimensional penalized smooth functions, Gaussian Process functions, monotonic smooth functions, &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;distributed lag nonlinear effects&lt;/a&gt;, seasonality and &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;time-varying seasonality&lt;/a&gt;, and hierarchical effects. It is also easy to generate probabilistic forecasts from these models, which you can learn more about by reading the &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/articles/forecast_evaluation.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;forecast and forecast evaluation vignette&lt;/a&gt;. These options should hopefully make &lt;code&gt;mvgam&lt;/code&gt; a very attractive resource for tackling real-world multivariate time series when we do not wish to ignore important drivers or use time series transformations that make both inference and prediction difficult. Thanks for your time!&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;further-reading&#34;&gt;Further reading&#xA;  &lt;a href=&#34;#further-reading&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The following papers and resources offer useful material about Vector Autoregressive models and Dynamic GAMs for time series modeling / forecasting&lt;/p&gt;&#xA;&lt;p&gt;Hampton, S. E., Holmes, E. E., Scheef, L. P., Scheuerell, M. D., Katz, S. L., Pendleton, D. E., &amp;amp; Ward, E. J. (2013). &#xA;&lt;a href=&#34;https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/13-0996.1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Quantifying effects of abiotic and biotic drivers on community dynamics with multivariate autoregressive (MAR) models&lt;/a&gt;. &lt;em&gt;Ecology&lt;/em&gt;, 94(12), 2663-2669.&lt;/p&gt;&#xA;&lt;p&gt;Hannaford, N. E., Heaps, S. E., Nye, T. M., Curtis, T. P., Allen, B., Golightly, A., &amp;amp; Wilkinson, D. J. (2023). &#xA;&lt;a href=&#34;https://www.sciencedirect.com/science/article/pii/S0167947322002390&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;A sparse Bayesian hierarchical vector autoregressive model for microbial dynamics in a wastewater treatment plant&lt;/a&gt;. &lt;em&gt;Computational Statistics &amp;amp; Data Analysis&lt;/em&gt;, 179, 107659.&lt;/p&gt;&#xA;&lt;p&gt;Heaps, S. E. (2023). &#xA;&lt;a href=&#34;https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Enforcing stationarity through the prior in vector autoregressions&lt;/a&gt;. &lt;em&gt;Journal of Computational and Graphical Statistics&lt;/em&gt;, 32(1), 74-83.&lt;/p&gt;&#xA;&lt;p&gt;Karunarathna, K. A. N. K., Wells, K., &amp;amp; Clark, N. J. (2024). &#xA;&lt;a href=&#34;https://www.sciencedirect.com/science/article/pii/S0304380024000371&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modelling nonlinear responses of a desert rodent species to environmental change with hierarchical dynamic generalized additive models&lt;/a&gt;. &lt;em&gt;Ecological Modelling&lt;/em&gt;, 490, 110648.&lt;/p&gt;&#xA;&lt;p&gt;Lütkepohl, H (2006). &#xA;&lt;a href=&#34;https://link.springer.com/book/10.1007/978-3-540-27752-1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;New introduction to multiple time series analysis&lt;/a&gt;. Springer, New York.&lt;/p&gt;&#xA;&lt;p&gt;Pesaran, P. H., &amp;amp; Yongcheol, S. (1998). &#xA;&lt;a href=&#34;https://www.sciencedirect.com/science/article/pii/S0165176597002140&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Generalized impulse response analysis in linear multivariate models&lt;/a&gt; &lt;em&gt;Economics Letters&lt;/em&gt; 58: 17-29.&lt;/p&gt;&#xA;</description>
  </item>
<item>
  <title>Incorporating time-varying seasonality in forecast models</title>
  <link>https://ecogambler.netlify.app/blog/time-varying-seasonality/</link>
  <pubDate>Tue, 11 Jun 2024 00:00:00 +0000</pubDate>
<guid>https://ecogambler.netlify.app/blog/time-varying-seasonality/</guid>
  <description>&lt;p&gt;Seasonality is very common in real-world time series. Many series vary in periodic, regular ways. For example, ice cream sales tend to be higher in warmer holiday months, while counts of migratory birds fluctuate strongly around the annual migration cycle. Because of how pervasive seasonality is, many time series and forecasting methods have been developed specifically to deal with this feature. For example, &#xA;&lt;a href=&#34;https://otexts.com/fpp3/seasonal-arima.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Seasonal ARIMA (SARIMA) models&lt;/a&gt; use differencing at seasonal lags to model seasonality in addition to other autoregressive features. Many types of &#xA;&lt;a href=&#34;https://otexts.com/fpp3/ets.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Exponential Smoothing models&lt;/a&gt; can also capture seasonality by propagating separate seasonal states in State-Space form. These methods are extremely useful for modeling real-valued time series and generating reasonable forecasts, and they can both readily handle time-varying seasonal patterns. But when it comes to regression-based models (&#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/mvgam-on-cran/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;which can do a &lt;em&gt;much&lt;/em&gt; better job capturing relevant features of the data, such as overdispersion, boundedness, missingness or zero-inflation&lt;/a&gt;), options for capturing seasonality, and time-varying seasonality, are more limited. The purpose of this brief post is to highlight one strategy for capturing seasonality, and time-varying seasonal patterns, in Dynamic Generalized Additive Models.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;environment-setup&#34;&gt;Environment setup&#xA;  &lt;a href=&#34;#environment-setup&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;This tutorial relies on the following packages:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(mvgam)           &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Fit, interrogate and forecast DGAMs&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(dplyr)           &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Tidy and flexible data manipulation&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(forecast)        &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Construct fourier terms for time series&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(ggplot2)         &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Flexible plotting&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme_set&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme_bw&lt;/span&gt;())      &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Black and White ggplot2 theme&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(gratia)          &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Graceful plotting of smooth terms&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(marginaleffects) &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Interrogating regression models&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(patchwork)       &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Combining ggplot objects&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(janitor)         &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Creating clean, tidy variable names&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;h1 id=&#34;plotting-a-seasonal-time-series&#34;&gt;Plotting a seasonal time series&#xA;  &lt;a href=&#34;#plotting-a-seasonal-time-series&#34;&gt;&lt;/a&gt;&#xA;&lt;/h1&gt;&#xA;&lt;p&gt;We will work with the &lt;code&gt;AirPassengers&lt;/code&gt; dataset, which is a time series of monthly international airline passengers from 1949 - 1960 (recorded in thousands). Load the data and plot the series&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;AirPassengers&amp;#34;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(AirPassengers, bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;, lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1.5&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-3-1.png&#34; alt=&#34;The AirPassengers time series in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;It is clear from this plot that there is strong seasonality in the passenger numers, but this pattern also appears to be changing over time. One common way to inpsect possible seasonal patterns is to calculate and plot an STL decomposition (Seasonal and Trend decomposition using Loess), which uses loess smoothing to iteratively smooth and remove certain components of the data (i.e. the long-term &lt;em&gt;trend&lt;/em&gt;, which may be nonlinear, and the potentially time-varying &lt;em&gt;seasoanality&lt;/em&gt;)&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;stl&lt;/span&gt;(AirPassengers, s.window &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;9&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;autoplot&lt;/span&gt;()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-4-1.png&#34; alt=&#34;An STL decomposition of the AirPassengers dataset in R, useful for time series modeling and forecasting&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;You can read about ways to modify this plot by changing the the periods over which the trend and seasonal components are smoothed using the &lt;code&gt;t.window&lt;/code&gt; and &lt;code&gt;s.window&lt;/code&gt; arguments, but they aren&amp;rsquo;t that important for this post. The key message is that there appears to be a long-term, nonlinear &lt;em&gt;trend&lt;/em&gt; and a cyclic seasonal pattern that varies over time, not just in magnitude but also perhaps a bit in shape. Now for some models. First let&amp;rsquo;s convert the series to a &lt;code&gt;data.frame()&lt;/code&gt; object that is suitable for modeling with the {&lt;code&gt;mgcv&lt;/code&gt;} and {&lt;code&gt;mvgam&lt;/code&gt;} packages. This function will also automatically split the data into training and testing sets, which makes it easy to evaluate different models on their forecasting abilities.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;airdat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;series_to_mvgam&lt;/span&gt;(AirPassengers, freq &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;frequency&lt;/span&gt;(AirPassengers))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;glimpse&lt;/span&gt;(airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Rows: 122&#xD;&#xA;## Columns: 6&#xD;&#xA;## $ y      &amp;lt;dbl&amp;gt; 112, 118, 132, 129, 121, 135, 148, 148, 136, 119, 104, 118, 115…&#xD;&#xA;## $ season &amp;lt;dbl&amp;gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, …&#xD;&#xA;## $ year   &amp;lt;dbl&amp;gt; 1949, 1949, 1949, 1949, 1949, 1949, 1949, 1949, 1949, 1949, 194…&#xD;&#xA;## $ date   &amp;lt;dttm&amp;gt; 1949-01-01 00:00:00, 1949-01-31 10:00:00, 1949-03-02 20:00:01,…&#xD;&#xA;## $ series &amp;lt;fct&amp;gt; series_1, series_1, series_1, series_1, series_1, series_1, ser…&#xD;&#xA;## $ time   &amp;lt;int&amp;gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, …&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Once the data are in the correct &lt;em&gt;long&lt;/em&gt; format, we can easily plot some features of the time series using some of {&lt;code&gt;mvgam&lt;/code&gt;}&amp;rsquo;s &lt;code&gt;S3&lt;/code&gt; functions&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_test)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-6-1.png&#34; alt=&#34;Features of the AirPassengers time series in R, including a CDF and ACF to view temporal autocorrelation&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;The Autocorrelation Function (ACF) plot clearly shows evidence of strong autocorrelation and seasonality, which we hope to capture in our models&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;fit-an-mvgam-model-using-a-tensor-product-interaction&#34;&gt;Fit an &lt;code&gt;mvgam&lt;/code&gt; model using a tensor product interaction&#xA;  &lt;a href=&#34;#fit-an-mvgam-model-using-a-tensor-product-interaction&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;Now we can fit a model to these data to try and capture both components, i.e. the trend and seasonal patterns. Those of you familiar with {&lt;code&gt;mgcv&lt;/code&gt;} will know that the traditional way to model time-varying effects is to use a &#xA;&lt;a href=&#34;https://rdrr.io/cran/mgcv/man/te.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;tensor product smooth (using the &lt;code&gt;te()&lt;/code&gt; wrapper)&lt;/a&gt; to capture a nonlinear interaction between &amp;rsquo;time&amp;rsquo; and whatever covariate we are interested in (&amp;lsquo;season&amp;rsquo;, in this case). This is a useful first step to model smoothly-varying effects, and we have a lot of flexibility to describe the marginal effects within a &lt;code&gt;te()&lt;/code&gt; smooth. For example, in the below model we set up the effect of &amp;lsquo;season&amp;rsquo; using &#xA;&lt;a href=&#34;https://fromthebottomoftheheap.net/2014/05/09/modelling-seasonal-data-with-gam/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a cyclic smooth (&lt;code&gt;bs = &#39;cc&#39;&lt;/code&gt;)&lt;/a&gt; that forces the seasonal pattern to begin and end in the same place (i.e. there is no discontinuity allowed at the end points of the spline, meaning that this effect constrains the smooth to be &lt;em&gt;periodic&lt;/em&gt;).&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvgam&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# A tensor product of season and time&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(season, time,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Cyclic and thin-plate marginal bases&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   bs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;cc&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;tp&amp;#39;&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Reasonable complexities&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;15&lt;/span&gt;)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Define where the seasonal ends should &amp;#39;join&amp;#39;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              knots &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;list&lt;/span&gt;(season &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0.5&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;12.5&lt;/span&gt;)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Allow for overdispersion in the count series&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;nb&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Define the data and newdata for automatic forecasting&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_test,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Silence printed messages&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              silent &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We can conveniently use &lt;code&gt;gratia::draw()&lt;/code&gt; to view the &amp;rsquo;time&amp;rsquo; * &amp;lsquo;season&amp;rsquo; smooth interaction function from the model&amp;rsquo;s underlying &lt;code&gt;gam&lt;/code&gt; object (stored in the &lt;code&gt;mgcv_model&lt;/code&gt; slot of the returned model object)&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;draw&lt;/span&gt;(mod1&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mgcv_model)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-8-1.png&#34; alt=&#34;Partial effect of time-varying seasonality from a Generalized Additive Model, fitted in mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;The primary seasonal pattern can be viewed using &lt;code&gt;plot_predictions()&lt;/code&gt; from the {&lt;code&gt;marginaleffects&lt;/code&gt;} package, &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/interpreting-gams/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;which is an extremely useful package for using targeted predictions to interrogate nonlinear effects from GAMs&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_predictions&lt;/span&gt;(mod1, condition &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;season&amp;#39;&lt;/span&gt;, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;link&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-9-1.png&#34; alt=&#34;Conditional seasonal effect from a Generalized Additive Model with time-varying seasonality, fitted in mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Out-of-sample forecasts from this model aren&amp;rsquo;t too bad here, but perhaps the uncertainty is a bit too wide. This is not unexpected if you take some time to understand how splines extrapolate beyond the training data&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mod1, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;forecast&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Out of sample DRPS:&#xD;&#xA;## 897.952959&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-10-1.png&#34; alt=&#34;Forecasts from a Dynamic Generalized Additive Model with time-varying seasonality using a tensor product, fitted in mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;This model is not too bad, but it might not be preferable for a few reasons:&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;We are capturing the temporal dimension with a spline, and we all know that &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;splines generally give poor extrapolation behaviours&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;This model assumes that the seasonal pattern changes at the same rate that the temporal spline changes, and this might not always be the most suitable model&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;using-fourier-terms-to-capture-time-varying-seasonality&#34;&gt;Using Fourier terms to capture time-varying seasonality&#xA;  &lt;a href=&#34;#using-fourier-terms-to-capture-time-varying-seasonality&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;There is another way we can model time-varying seasonality, in this case using a &#xA;&lt;a href=&#34;https://otexts.com/fpp3/useful-predictors.html#useful-predictors&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Fourier transform&lt;/a&gt;. A Fourier series uses sets of sine and cosine terms at different frequencies, which can be weighted to approximate a huge variety of periodic functions. First compute sine and cosine functions using the &lt;code&gt;forecast::fourier()&lt;/code&gt; function, which automatically recognises the monthly periodicity of the &lt;code&gt;AirPassengers&lt;/code&gt; data to calculate Fourier terms of the corrrect frequencies. Here we set the order &lt;code&gt;K&lt;/code&gt; equal to &lt;code&gt;4&lt;/code&gt;, which gives us a total of &lt;code&gt;8&lt;/code&gt; sine and cosine predictors that we can use as regressors in our dynamic model. This sort of model is often referred to as &#xA;&lt;a href=&#34;https://otexts.com/fpp3/dhr.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;em&gt;harmonic regression&lt;/em&gt;&lt;/a&gt; because the successive Fourier terms can be thought of as representing harmonics of the previous Fourier terms.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data.frame&lt;/span&gt;(forecast&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;fourier&lt;/span&gt;(AirPassengers, K &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Use clean_names as fourier() gives terrible name types&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  janitor&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;clean_names&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&amp;gt;&lt;/span&gt; fourier_terms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;glimpse&lt;/span&gt;(fourier_terms)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Rows: 144&#xD;&#xA;## Columns: 8&#xD;&#xA;## $ s1_12 &amp;lt;dbl&amp;gt; 0.5000000, 0.8660254, 1.0000000, 0.8660254, 0.5000000, 0.0000000…&#xD;&#xA;## $ c1_12 &amp;lt;dbl&amp;gt; 0.8660254, 0.5000000, 0.0000000, -0.5000000, -0.8660254, -1.0000…&#xD;&#xA;## $ s2_12 &amp;lt;dbl&amp;gt; 0.8660254, 0.8660254, 0.0000000, -0.8660254, -0.8660254, 0.00000…&#xD;&#xA;## $ c2_12 &amp;lt;dbl&amp;gt; 0.5, -0.5, -1.0, -0.5, 0.5, 1.0, 0.5, -0.5, -1.0, -0.5, 0.5, 1.0…&#xD;&#xA;## $ s3_12 &amp;lt;dbl&amp;gt; 1, 0, -1, 0, 1, 0, -1, 0, 1, 0, -1, 0, 1, 0, -1, 0, 1, 0, -1, 0,…&#xD;&#xA;## $ c3_12 &amp;lt;dbl&amp;gt; 0, -1, 0, 1, 0, -1, 0, 1, 0, -1, 0, 1, 0, -1, 0, 1, 0, -1, 0, 1,…&#xD;&#xA;## $ s4_12 &amp;lt;dbl&amp;gt; 0.8660254, -0.8660254, 0.0000000, 0.8660254, -0.8660254, 0.00000…&#xD;&#xA;## $ c4_12 &amp;lt;dbl&amp;gt; -0.5, -0.5, 1.0, -0.5, -0.5, 1.0, -0.5, -0.5, 1.0, -0.5, -0.5, 1…&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Viewing these Fourier terms (for the first 24 time points) gives a sense of how they can be thought of as a particular type of basis expansion&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.matrix&lt;/span&gt;(fourier_terms)[1&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;24&lt;/span&gt;,], type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ylab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Function value&amp;#39;&lt;/span&gt;, xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; viridis&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;viridis&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;8&lt;/span&gt;), lty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1.5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-12-1.png&#34; alt=&#34;Fourier terms for a dynamic harmonic regression&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;Now we can add these new predictors to the training and testing datasets. It is important that we have these terms for the out-of-sample testing set as well, because these will be used to help compute forecasts from our model&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;bind_cols&lt;/span&gt;(fourier_terms[1&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NROW&lt;/span&gt;(airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train), ])&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_test &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_test &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;bind_cols&lt;/span&gt;(fourier_terms&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;[&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NROW&lt;/span&gt;(airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                   &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NROW&lt;/span&gt;(fourier_terms), ])&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Next we can fit an &lt;code&gt;mvgam()&lt;/code&gt; model that includes a smooth nonlinear temporal trend and time-varying seasonality, but using the Fourier terms in place of the cyclic smooth like we did above. This is done by first using a monotonic smooth of &amp;rsquo;time&amp;rsquo; that ensures the temporal trend never declines, which seems appropriate here. The {&lt;code&gt;mvgam&lt;/code&gt;} package includes options for monotonically increasing or monotonically decreasing smooths using the &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/reference/monotonic.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;moi&lt;/code&gt; and &lt;code&gt;mod&lt;/code&gt; basis constructors&lt;/a&gt;. This is a nice feature that is difficult to incorporate in normal GAMs fitted in either {&lt;code&gt;mgcv&lt;/code&gt;} or {&lt;code&gt;brms&lt;/code&gt;}. The time-varying seasonality is captured by allowing the coefficients on the Fourier terms to vary over time using separate splines that take advantage of the &lt;code&gt;&#39;by&#39;&lt;/code&gt; argument in the &lt;code&gt;s()&lt;/code&gt; wrapper. This effectively sets up independent smooths of &amp;rsquo;time&amp;rsquo; that are then interacted with the Fourier terms, formulating a time-varying coefficient model for each Fourier term.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvgam&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Monotonic smooth of time to ensure the trend&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# either increases or flattens, but does not &lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# decrease&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, bs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;moi&amp;#39;&lt;/span&gt;, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Time-varying fourier coefficients to capture&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# possibly changing seasonality&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; s1_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c1_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; s2_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c2_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; s3_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c3_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Response family and data as before&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;nb&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_test,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              silent &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Of course this model still uses a spline of &amp;rsquo;time&amp;rsquo; for the trend, but the monotonic restriction ensures that the predictions are at least somewhat controllable. This second model is preferred based on in-sample fits, which we can readily compare using the Approximate Leave-One-Out Cross-Validation with functionality from the wonderful &#xA;&lt;a href=&#34;https://mc-stan.org/loo/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;{&lt;code&gt;loo&lt;/code&gt;} package&lt;/a&gt;. A higher Expected Log Predictive Density (ELPD) is preferred here&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;loo_compare&lt;/span&gt;(mod1, mod2)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;##      elpd_diff se_diff&#xD;&#xA;## mod2   0.0       0.0  &#xD;&#xA;## mod1 -16.8       2.8&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;But what about forecasts? Here we plot out-of-sample forecasts from both models, which again show that the second model is slightly preferred&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;layout&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mod1, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;forecast&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Out of sample DRPS:&#xD;&#xA;## 897.952959&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mod2, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;forecast&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Out of sample DRPS:&#xD;&#xA;## 667.239806&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-16-1.png&#34; alt=&#34;Comparing forecast distributions from two Dynamic Generalized Additive Models with time-varying seasonal components, fitted in mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;layout&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Look at the partial effect plots for the smooths to see how some of the Fourier coefficients are estimated to change over time&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;gratia&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;draw&lt;/span&gt;(mod2&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mgcv_model, select &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;7&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-17-1.png&#34; alt=&#34;Time-varying Fourier coefficients from a Dynamic Harmonic Regression, fitted in mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;plotting-trend-and-seasonal-components-from-a-harmonic-regression&#34;&gt;Plotting trend and seasonal components from a harmonic regression&#xA;  &lt;a href=&#34;#plotting-trend-and-seasonal-components-from-a-harmonic-regression&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;Plotting this model takes a bit more work, as we need to use targeted predictions from the model to visualise the two primary effects (i.e. the nonlinear trend and the time-varying seasonality).&lt;/p&gt;&#xA;&lt;p&gt;First a plot of the trend, which can be done easily in this model using the &lt;code&gt;&#39;condition&#39;&lt;/code&gt; argument in &lt;code&gt;plot_predictions()&lt;/code&gt; to compute expectations from the model (i.e. predictions on the outcome scale, but ignoring the overdispersion parameter from the Negative Binomial sampling distribution)&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_predictions&lt;/span&gt;(mod2, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       condition &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;time&amp;#39;&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;expected&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Expected passengers&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       title &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Long-term trend&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And now the time-varying seasonal pattern, which requires subtracting the conditional trend predictions from the total predictions&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;with_season &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;predict&lt;/span&gt;(mod2, summary &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;expected&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;agg_over_season &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;predict&lt;/span&gt;(mod2, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                           newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;datagrid&lt;/span&gt;(model &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mod2,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                              time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; unique),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                           summary &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                           type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;expected&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;season_preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; with_season &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&lt;/span&gt; agg_over_season&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(airdat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;data_train &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;               dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(pred &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(season_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, mean),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                             upper &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(season_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;quantile&lt;/span&gt;(x, probs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.975&lt;/span&gt;)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                             lower &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(season_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;quantile&lt;/span&gt;(x, probs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.025&lt;/span&gt;))),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; time, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; pred)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_ribbon&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(ymax &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; upper,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  ymin &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; lower),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              alpha &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.2&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_line&lt;/span&gt;()&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Expected passengers&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       title &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time-varying seasonality&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We can now plot these effects together using functionality from the {&lt;code&gt;patchwork&lt;/code&gt;} package&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; p2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_layout&lt;/span&gt;(ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-20-1.png&#34; alt=&#34;Plotting nonlinear trends and time-varying seasonality from a harmonic regression Dynamic Generalized Additive Model, fitted in mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;This plot clearly shows how the model has estimated both components, and that the seasonal pattern changes in both shape and magnitude over time&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;time-varying-periodicity&#34;&gt;Time-varying periodicity?&#xA;  &lt;a href=&#34;#time-varying-periodicity&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The above example shows how Fourier terms can be used to capture time-varying seasonality. But what if the periodicity itself is changing over time? In other words, how might we model a series that starts out with regular periodic variation that occurs every ~ 8 weeks but that proceeds to show a shrinking or expanding periodic window? Below is a very brief example of how we could expand the Fourier strategy to potentially model this&lt;/p&gt;&#xA;&lt;p&gt;First, I define function to construct monotonically increasing or decreasing&#xA;coefficients. This will be helpful to simulate time-varying periodicity&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;monotonic_fun &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(times, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;sort&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.vector&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;scale&lt;/span&gt;(times)))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exp&lt;/span&gt;(k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;*&lt;/span&gt; x) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;/&lt;/span&gt; (&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exp&lt;/span&gt;(k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;*&lt;/span&gt; x))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now for the simulation, which involves constructing Fourier series for two different periodicities (&lt;code&gt;k = 12&lt;/code&gt; and &lt;code&gt;k = 6&lt;/code&gt; in this example), each with three Fourier terms. I then simulate time-varying coefficients for these terms, forcing the period-12 terms to decline toward zero over time while allowing the period-6 terms to increase over time. These coefficients, together with the simulated Fourier terms themselves, should give us the ingredients to simulate a time series in which the periodicity shrinks from ~12 to ~6 over time&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;set.seed&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;123&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;times &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;120&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Construct Fourier series for two different periodicities&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data.frame&lt;/span&gt;(forecast&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;fourier&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ts&lt;/span&gt;(times, frequency &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;), K &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;bind_cols&lt;/span&gt;(forecast&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;fourier&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ts&lt;/span&gt;(times, frequency &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;), K &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Use clean_names as fourier() gives terrible name types&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  janitor&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;clean_names&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&amp;gt;&lt;/span&gt; fourier_terms&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Create the time-varying Fourier coefficients&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;betas &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NA&lt;/span&gt;, nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(times), ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NCOL&lt;/span&gt;(fourier_terms))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Period 12 coefficients drop montonically toward zero over time&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p12_names &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;grep&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;_12&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;names&lt;/span&gt;(fourier_terms), fixed &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; p12_names){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  betas[, i] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;monotonic_fun&lt;/span&gt;(times, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;runif&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;-3&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;-0.25&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Period 6 coefficients increase monotonically over time&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p6_names &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;grep&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;_6&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;names&lt;/span&gt;(fourier_terms), fixed &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; p6_names){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  betas[, i] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;monotonic_fun&lt;/span&gt;(times, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;runif&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.25&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Plot the Fourier coefficients through time&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matplot&lt;/span&gt;(betas, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;, xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; viridis&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;viridis&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;8&lt;/span&gt;), lty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1.5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-23-1.png&#34; alt=&#34;Time-varying periodicity simulated in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Now calculate the linear predictor and plot it&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mu &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;vector&lt;/span&gt;(length &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(times))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(times)){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  mu[i] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.matrix&lt;/span&gt;(fourier_terms)[i, ] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%*%&lt;/span&gt; betas[i, ] &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mu, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;, xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-24-1.png&#34; alt=&#34;Time-varying periodicity simulated in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Finally, add some Gaussian Random Walk noise and plot the resulting simulated time series&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; mu &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;cumsum&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rnorm&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(times), sd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.25&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(y, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;, xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-25-1.png&#34; alt=&#34;Time-varying periodicity simulated in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Now we can construct the data for modeling; this assumes we&amp;rsquo;ve thought carefully about the problem and have included the Fourier series for both periodicities as predictors&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;dat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data.frame&lt;/span&gt;(y, time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; times) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;bind_cols&lt;/span&gt;(fourier_terms)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And we can now fit the dynamic GAM, which uses a State-Space representation&#xA;to capture time-varying seasonality, periodicity and the Random Walk autocorrelation process&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod3 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvgam&lt;/span&gt;(&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Observation formula; empty&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;-1&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Process formula contains the seasonal terms&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  trend_formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Time-varying fourier coefficients to capture&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# possibly changing seasonality AND periodicity&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; s1_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c1_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; s2_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c2_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; s3_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c3_12, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; s1_6, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c1_6, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; s2_6, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c2_6, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; c3_6, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Random walk for the trend&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  trend_model &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;RW&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Gaussian observations&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gaussian&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Realistic priors on variance components&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  priors &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exponential&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; sigma),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exponential&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; sigma_obs)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Sampler settings&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  burnin &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1000&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  samples &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1000&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  silent &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Data&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; dat)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Plot the time-varying Fourier coefficients as before, using &lt;code&gt;gratia::draw()&lt;/code&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;gratia&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;draw&lt;/span&gt;(mod3&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;trend_mgcv_model)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-28-1.png&#34; alt=&#34;Time-varying Fourier coefficients to model time-varying periodicity in mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;As before, our model has successfully captured the time-varying coefficients for these terms. Notice how many of the period-12 terms (i.e. &lt;code&gt;s1_12&lt;/code&gt; and &lt;code&gt;c3_12&lt;/code&gt;) are estimated to decline over time, while many of the period-6 terms (i.e. &lt;code&gt;s2_6&lt;/code&gt; and &lt;code&gt;c3_6&lt;/code&gt;) are estimated to increase over time. It is encouraging that the model has been able to find these while also dealing with the Random Walk autocorrelation process and the two variance terms (process error and observation error).&lt;/p&gt;&#xA;&lt;p&gt;We can also plot the time-varying seasonality using posterior expectations as we did for the first example above. But note that this plot does not include the Random Walk component in its predictions&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;season_preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;predict&lt;/span&gt;(mod3, summary &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;expected&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(dat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(pred &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(season_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, mean),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       upper &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(season_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                         &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;quantile&lt;/span&gt;(x, probs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.975&lt;/span&gt;)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       lower &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(season_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                         &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;quantile&lt;/span&gt;(x, probs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.025&lt;/span&gt;))),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; time, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; pred)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_ribbon&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(ymax &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; upper,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  ymin &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; lower),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              alpha &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.2&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_line&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Posterior expectations&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       title &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time-varying seasonality&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now we can extract the RW trend that was estimated and subtract the seasonal predictions, which will give us a view of the potentially nonlinear trend that was estimated by the model&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;trend_preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;hindcast&lt;/span&gt;(mod3, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;expected&amp;#39;&lt;/span&gt;)&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;hindcasts[[1]] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  season_preds&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(dat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(pred &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(trend_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, mean),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       upper &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(trend_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                         &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;quantile&lt;/span&gt;(x, probs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.975&lt;/span&gt;)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       lower &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(trend_preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                         &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;quantile&lt;/span&gt;(x, probs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.025&lt;/span&gt;))),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; time, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; pred)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_ribbon&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(ymax &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; upper,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  ymin &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; lower),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              alpha &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.2&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_line&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Posterior expectations&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       title &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;RW trend&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Once again, we can plot the two together using {&lt;code&gt;patchwork&lt;/code&gt;}&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;p1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; p2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_layout&lt;/span&gt;(ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/time-varying-seasonality/index_files/figure-html/unnamed-chunk-31-1.png&#34; alt=&#34;Capturing time-varying periodicity in harmonic regression models using mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;This post has hopefully given you some ideas about useful modeling strategies for dealing with time-varying seasonality. Of course, we may want to try and &lt;em&gt;explain&lt;/em&gt; why seasonality varies over time. In that case, I often find &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;distributed lag predictors&lt;/a&gt; to be especially helpful. Thanks for reading!&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;further-reading&#34;&gt;Further reading&#xA;  &lt;a href=&#34;#further-reading&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The following papers and resources offer useful material about Dynamic Harmonic Regression and using GAMs for time series modeling / forecasting&lt;/p&gt;&#xA;&lt;p&gt;Autin, M. A., &amp;amp; Edwards, D. &#xA;&lt;a href=&#34;https://onlinelibrary.wiley.com/doi/abs/10.1002/env.1013&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Nonparametric harmonic regression for estuarine water quality data&lt;/a&gt; &lt;em&gt;Environmetrics&lt;/em&gt; 21.6 (2010): 588-605.&lt;/p&gt;&#xA;&lt;p&gt;Karunarathna, K. A. N. K., Wells, K., &amp;amp; Clark, N. J. (2024). &#xA;&lt;a href=&#34;https://www.sciencedirect.com/science/article/pii/S0304380024000371&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modelling nonlinear responses of a desert rodent species to environmental change with hierarchical dynamic generalized additive models&lt;/a&gt;. &lt;em&gt;Ecological Modelling&lt;/em&gt;, 490, 110648.&lt;/p&gt;&#xA;&lt;p&gt;Young, P. C., Pedregal, D. J., &amp;amp; Tych, W. (1999). &#xA;&lt;a href=&#34;https://onlinelibrary.wiley.com/doi/10.1002/%28SICI%291099-131X%28199911%2918:6%3C369::AID-FOR748%3E3.0.CO;2-K&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Dynamic harmonic regression&lt;/a&gt;. &lt;em&gt;Journal of Forecasting&lt;/em&gt;, 18, 369–394.&lt;/p&gt;&#xA;</description>
  </item>
<item>
  <title>First release of mvgam(v1.1.0) to CRAN</title>
  <link>https://ecogambler.netlify.app/blog/mvgam-on-cran/</link>
  <pubDate>Wed, 08 May 2024 00:00:00 +0000</pubDate>
<guid>https://ecogambler.netlify.app/blog/mvgam-on-cran/</guid>
  <description>&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;welcoming-mvgam-to-the-comprehensive-r-archive-network-cran&#34;&gt;Welcoming mvgam to the Comprehensive R Archive Network (CRAN)&#xA;  &lt;a href=&#34;#welcoming-mvgam-to-the-comprehensive-r-archive-network-cran&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The goal of &lt;code&gt;mvgam&lt;/code&gt; is to use a Bayesian framework to estimate parameters of Dynamic Generalized Additive Models (DGAMs) for time series with dynamic trend components. The package provides an interface to fit Bayesian DGAMs using &#xA;&lt;a href=&#34;https://mc-stan.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;Stan&lt;/code&gt;&lt;/a&gt; as the backend, and is particularly suited to the estimation of complex State-Space models. The formula syntax is based on that of the package &#xA;&lt;a href=&#34;https://cran.r-project.org/web/packages/mgcv/index.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;mgcv&lt;/code&gt;&lt;/a&gt; to provide a familiar GAM modelling interface. There is also built-in support for the increasingly powerful &#xA;&lt;a href=&#34;https://marginaleffects.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;marginaleffects&lt;/code&gt; package&lt;/a&gt; to make interpretation easy. The motivation for the package and some of its primary objectives are described in detail by Clark &amp;amp; Wells 2022 (published in &#xA;&lt;a href=&#34;https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13974&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Methods in Ecology and Evolution&lt;/a&gt;). An introduction to the package and some worked examples are also shown in the below seminar:&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Ecological Forecasting with Dynamic Generalized Additive Models DGAMs)&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;div style=&#34;position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;&#34;&gt;&#xA;  &lt;iframe src=&#34;https://www.youtube-nocookie.com/embed/0zZopLlomsQ&#34; style=&#34;position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;&#34; allowfullscreen title=&#34;YouTube Video&#34;&gt;&lt;/iframe&gt;&#xA;&lt;/div&gt;&#xA;&lt;p&gt;The first release of &lt;code&gt;mvgam&lt;/code&gt; &#xA;&lt;a href=&#34;https://cran.rstudio.com/web/packages/mvgam/index.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;has now been published on CRAN&lt;/a&gt;. While the package has featured on this blog before, for example when I explained &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;hierarchical distributed lag models&lt;/a&gt; and &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;how to model temporally autocorrelated time series with nonlinear trends&lt;/a&gt;, I have not thorougly introduced the it yet. So the purpose of this brief post is to cover some of the features of this stable release, and to hint at a few of the development goals for upcoming releases.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;what-are-generalized-additive-models-gams&#34;&gt;What are Generalized Additive Models (GAMs)?&#xA;  &lt;a href=&#34;#what-are-generalized-additive-models-gams&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;Generalized Additive Models (GAMs) are flexible tools that replace one or more predictors in a Generalized Linear Model (GLM) with &lt;em&gt;smooth functions&lt;/em&gt; of predictors. These are helpful for learning arbitrarily complex, nonlinear relationships between predictors and conditional responses without needing &lt;em&gt;a priori&lt;/em&gt; expectations about the shapes of these relationships. Rather, they are learned using &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;em&gt;penalized smoothing splines&lt;/em&gt;&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;smooth_only.gif&#34; alt=&#34;Generalized Additive Models learn nonlinear effects from data using smoothing splines&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;How do these work? The secret is a &lt;em&gt;basis expansion&lt;/em&gt;, which in lay terms means that the covariate (time, in this example) is evaluated at a smaller set of &lt;em&gt;basis functions&lt;/em&gt; designed to cover the range of the observed covariate values. Below is one particular type of basis, called a cubic regression basis.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;basis-functions-1.svg&#34; alt=&#34;How basis functions can be used to build a smoothing spline in a GAM&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;Each basis function acts on its own local neighbourhood of the covariate. Once we have constructed the basis, we can estimate weights for each function. The weights allow the basis functions to have different impacts on the shape of the spline. They also give us a target for learning splines from data, as the weights act as the regression coefficients.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;basis_weights.gif&#34; alt=&#34;How basis functions can be used to build a smoothing spline in a GAM&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;There are many more types of basis expansions that can be used to form penalized smooths, including multidimensional smooths, spatial smooths or even monotonic smooths. For more information on GAMs and how they can smooth through data, see &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/interpreting-gams/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;my blogpost on how to interpret nonlinear effects from Generalized Additive Models&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;what-does-mvgam-do&#34;&gt;What does mvgam do?&#xA;  &lt;a href=&#34;#what-does-mvgam-do&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;&lt;code&gt;mvgam&lt;/code&gt; is designed to propagate unobserved temporal processes to capture latent dynamics in the observed time series. This works in a state-space format, with the temporal &lt;em&gt;trend&lt;/em&gt; evolving independently of the observation process. Briefly, assume &lt;code&gt;\(\tilde{\boldsymbol{y}}_{i,t}\)&lt;/code&gt; is the conditional expectation of response variable &lt;code&gt;\(\boldsymbol{i}\)&lt;/code&gt; at time &lt;code&gt;\(\boldsymbol{t}\)&lt;/code&gt;. Assuming &lt;code&gt;\(\boldsymbol{y_i}\)&lt;/code&gt; is drawn from an exponential distribution with an invertible link function, the linear predictor for a multivariate Dynamic GAM can be written as:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$for~i~in~1:N_{series}~...$$&lt;/code&gt;&#xA;&lt;code&gt;$$for~t~in~1:N_{timepoints}~...$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$g^{-1}(\tilde{\boldsymbol{y}}_{i,t})=\alpha_{i}+\sum\limits_{j=1}^J\boldsymbol{s}_{i,j,t}\boldsymbol{x}_{j,t}+\boldsymbol{z}_{i,t}\,,$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;Here &lt;code&gt;\(\alpha\)&lt;/code&gt; are the unknown intercepts, the &lt;code&gt;\(\boldsymbol{s}\)&lt;/code&gt;&amp;rsquo;s are unknown smooth functions of covariates &lt;code&gt;\((\boldsymbol{x})\)&lt;/code&gt;&amp;rsquo;s, which can potentially vary among the response series, and &lt;code&gt;\(\boldsymbol{z}\)&lt;/code&gt; are dynamic latent processes. Each smooth function &lt;code&gt;\(\boldsymbol{s_j}\)&lt;/code&gt; is composed of basis expansions whose coefficients, which must be estimated, control the functional relationship between &lt;code&gt;\(\boldsymbol{x}_{j}\)&lt;/code&gt; and &lt;code&gt;\(g^{-1}(\tilde{\boldsymbol{y}})\)&lt;/code&gt;. But note that we can also include smooth functions of covariates in the process models &lt;code&gt;\(\boldsymbol{z}\)&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Several advantages of GAMs are that they can model a diversity of response families, including discrete distributions (i.e. Poisson, Negative Binomial, Gamma) that accommodate common ecological features such as zero-inflation or overdispersion, and that they can be formulated to include hierarchical smoothing for multivariate responses. &lt;code&gt;mvgam&lt;/code&gt; supports a number of different observation families, which are summarized below.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;supported-observation-families&#34;&gt;Supported observation families&#xA;  &lt;a href=&#34;#supported-observation-families&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;&lt;code&gt;mvgam&lt;/code&gt; was originally designed to analyse and forecast time series of non-negative integer-valued data (counts). These data are traditionally challenging to analyse with existing time series analysis packages. But further development of &lt;code&gt;mvgam&lt;/code&gt; has resulted in support for a growing number of observation families that extend to other types of data. Currently, the package can handle data for the following families:&lt;/p&gt;&#xA;&lt;table&gt;&#xA;&lt;thead&gt;&#xA;&lt;tr&gt;&#xA;&lt;th style=&#34;text-align:center&#34;&gt;Distribution&lt;/th&gt;&#xA;&lt;th style=&#34;text-align:center&#34;&gt;Function&lt;/th&gt;&#xA;&lt;th style=&#34;text-align:center&#34;&gt;Support&lt;/th&gt;&#xA;&lt;th style=&#34;text-align:center&#34;&gt;Extra parameter(s)&lt;/th&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/thead&gt;&#xA;&lt;tbody&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Gaussian (identity link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;gaussian()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Real values in &lt;code&gt;\((-\infty, \infty)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;\(\sigma\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Student&amp;rsquo;s T (identity link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;student-t()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Heavy-tailed real values in &lt;code&gt;\((-\infty, \infty)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;\(\sigma\)&lt;/code&gt;, &lt;code&gt;\(\nu\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;LogNormal (identity link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;lognormal()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Positive real values in &lt;code&gt;\([0, \infty)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;\(\sigma\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Gamma (log link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;Gamma()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Positive real values in &lt;code&gt;\([0, \infty)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;\(\alpha\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Beta (logit link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;betar()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Real values (proportional) in &lt;code&gt;\([0,1]\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;\(\phi\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Bernoulli (logit link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;bernoulli()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Binary data in &lt;code&gt;\({0,1}\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;-&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Poisson (log link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;poisson()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Non-negative integers in &lt;code&gt;\((0,1,2,...)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;-&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Negative Binomial2 (log link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;nb()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Non-negative integers in &lt;code&gt;\((0,1,2,...)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;\(\phi\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Binomial (logit link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;binomial()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Non-negative integers in &lt;code&gt;\((0,1,2,...)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;-&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Beta-Binomial (logit link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;beta_binomial()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Non-negative integers in &lt;code&gt;\((0,1,2,...)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;\(\phi\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Poisson Binomial N-mixture (log link)&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;&lt;code&gt;nmix()&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;Non-negative integers in &lt;code&gt;\((0,1,2,...)\)&lt;/code&gt;&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;-&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;p&gt;For all supported observation families, any extra parameters that need to be estimated (i.e. the &lt;code&gt;\(\sigma\)&lt;/code&gt; in a Gaussian model or the &lt;code&gt;\(\phi\)&lt;/code&gt; in a Negative Binomial model) are by default estimated independently for each series. However, users can opt to force all series to share extra observation parameters using &lt;code&gt;share_obs_params = TRUE&lt;/code&gt; in &lt;code&gt;mvgam()&lt;/code&gt;. Note that default link functions cannot currently be changed.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;supported-temporal-dynamic-processes&#34;&gt;Supported temporal dynamic processes&#xA;  &lt;a href=&#34;#supported-temporal-dynamic-processes&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The dynamic processes that &lt;code&gt;mvgam&lt;/code&gt; can fit to time series can take a wide variety of forms, some of which can be multivariate to allow the different time series to interact or be correlated. When using the &lt;code&gt;mvgam()&lt;/code&gt; function, the user chooses between different process models with the &lt;code&gt;trend_model&lt;/code&gt; argument. Available process models are described in &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/reference/mvgam_trends.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;?mvgam_trends&lt;/code&gt;&lt;/a&gt; and detailed below.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;independent-random-walks&#34;&gt;Independent Random Walks&#xA;  &lt;a href=&#34;#independent-random-walks&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;Use &lt;code&gt;trend_model = &#39;RW&#39;&lt;/code&gt; or &lt;code&gt;trend_model = RW()&lt;/code&gt; to set up a model where each series in &lt;code&gt;data&lt;/code&gt; has independent latent temporal dynamics of the form:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z_{i,t} &amp;amp; \sim \text{Normal}(z_{i,t-1}, \sigma_i) \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;Process error parameters &lt;code&gt;\(\sigma\)&lt;/code&gt; are modeled independently for each series. If a moving average process is required, use &lt;code&gt;trend_model = RW(ma = TRUE)&lt;/code&gt; to set up the following:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z_{i,t} &amp;amp; = z_{i,t-1} + \theta_i * error_{i,t-1} + error_{i,t} \\&#xD; error_{i,t} &amp;amp; \sim \text{Normal}(0, \sigma_i) \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;Moving average coefficients &lt;code&gt;\(\theta\)&lt;/code&gt; are independently estimated for each series and will be forced to be stationary by default &lt;code&gt;\((abs(\theta)&amp;lt;1)\)&lt;/code&gt;. Only moving averages of order &lt;code&gt;\(q=1\)&lt;/code&gt; are currently allowed.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;multivariate-random-walks&#34;&gt;Multivariate Random Walks&#xA;  &lt;a href=&#34;#multivariate-random-walks&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;If more than one series is included in &lt;code&gt;data&lt;/code&gt; &lt;code&gt;\((N_{series} &amp;gt; 1)\)&lt;/code&gt;, a multivariate Random Walk can be set up using &lt;code&gt;trend_model = RW(cor = TRUE)&lt;/code&gt;, resulting in the following:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z_{t} &amp;amp; \sim \text{MVNormal}(z_{t-1}, \Sigma) \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;Where the latent process estimate &lt;code&gt;\(z_t\)&lt;/code&gt; now takes the form of a vector. The covariance matrix &lt;code&gt;\(\Sigma\)&lt;/code&gt; will capture contemporaneously correlated process errors. It is parameterised using a Cholesky factorization, which requires priors on the series-level variances &lt;code&gt;\(\sigma\)&lt;/code&gt; and on the strength of correlations using &lt;code&gt;Stan&lt;/code&gt;&amp;rsquo;s &lt;code&gt;lkj_corr_cholesky&lt;/code&gt; distribution.&lt;/p&gt;&#xA;&lt;p&gt;Moving average terms can also be included for multivariate random walks, in which case the moving average coefficients &lt;code&gt;\(\theta\)&lt;/code&gt; will be parameterised as an &lt;code&gt;\(N_{series} * N_{series}\)&lt;/code&gt; matrix&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;autoregressive-processes&#34;&gt;Autoregressive processes&#xA;  &lt;a href=&#34;#autoregressive-processes&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;Autoregressive models up to &lt;code&gt;\(p=3\)&lt;/code&gt;, in which the autoregressive coefficients are estimated independently for each series, can be used by specifying &lt;code&gt;trend_model = &#39;AR1&#39;&lt;/code&gt;, &lt;code&gt;trend_model = &#39;AR2&#39;&lt;/code&gt;, &lt;code&gt;trend_model = &#39;AR3&#39;&lt;/code&gt;, or &lt;code&gt;trend_model = AR(p = 1, 2, or 3)&lt;/code&gt;. For example, a univariate AR(1) model takes the form:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z_{i,t} &amp;amp; \sim \text{Normal}(ar1_i * z_{i,t-1}, \sigma_i) \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;All options are the same as for Random Walks, but additional options will be available for placing priors on the autoregressive coefficients. By default, these coefficients will not be forced into stationarity, but users can impose this restriction by changing the upper and lower bounds on their priors. See &lt;code&gt;?get_mvgam_priors&lt;/code&gt; for more details.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;vector-autoregressive-processes&#34;&gt;Vector Autoregressive processes&#xA;  &lt;a href=&#34;#vector-autoregressive-processes&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;A Vector Autoregression of order &lt;code&gt;\(p=1\)&lt;/code&gt; can be specified if &lt;code&gt;\(N_{series} &amp;gt; 1\)&lt;/code&gt; using &lt;code&gt;trend_model = &#39;VAR1&#39;&lt;/code&gt; or &lt;code&gt;trend_model = VAR()&lt;/code&gt;. A VAR(1) model takes the form:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z_{t} &amp;amp; \sim \text{Normal}(A * z_{t-1}, \Sigma) \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;Where &lt;code&gt;\(A\)&lt;/code&gt; is an &lt;code&gt;\(N_{series} * N_{series}\)&lt;/code&gt; matrix of autoregressive coefficients in which the diagonals capture lagged self-dependence (i.e. the effect of a process at time &lt;code&gt;\(t\)&lt;/code&gt; on its own estimate at time &lt;code&gt;\(t+1\)&lt;/code&gt;), while off-diagonals capture lagged cross-dependence (i.e. the effect of a process at time &lt;code&gt;\(t\)&lt;/code&gt; on the process for another series at time &lt;code&gt;\(t+1\)&lt;/code&gt;). By default, the covariance matrix &lt;code&gt;\(\Sigma\)&lt;/code&gt; will assume no process error covariance by fixing the off-diagonals to &lt;code&gt;\(0\)&lt;/code&gt;. To allow for correlated errors, use &lt;code&gt;trend_model = &#39;VAR1cor&#39;&lt;/code&gt; or &lt;code&gt;trend_model = VAR(cor = TRUE)&lt;/code&gt;. A moving average of order &lt;code&gt;\(q=1\)&lt;/code&gt; can also be included using &lt;code&gt;trend_model = VAR(ma = TRUE, cor = TRUE)&lt;/code&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Note that for all VAR models, stationarity of the process is enforced with a structured prior distribution that is described in detail in &#xA;&lt;a href=&#34;https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Heaps 2022&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Heaps, Sarah E. &amp;ldquo;&#xA;&lt;a href=&#34;https://www.tandfonline.com/doi/full/10.1080/10618600.2022.2079648&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Enforcing stationarity through the prior in vector autoregressions.&lt;/a&gt;&amp;rdquo; &lt;em&gt;Journal of Computational and Graphical Statistics&lt;/em&gt; 32.1 (2023): 74-83.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;gaussian-processes&#34;&gt;Gaussian Processes&#xA;  &lt;a href=&#34;#gaussian-processes&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;The final option for modelling temporal dynamics is to use a Gaussian Process with squared exponential kernel. These are set up independently for each series (there is currently no multivariate GP option), using &lt;code&gt;trend_model = &#39;GP&#39;&lt;/code&gt;. The dynamics for each latent process are modelled as:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z &amp;amp; \sim \text{MVNormal}(0, \Sigma_{error}) \\&#xD; \Sigma_{error}[t_i, t_j] &amp;amp; = \alpha^2 * exp(-0.5 * ((|t_i - t_j| / \rho))^2) \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;The latent dynamic process evolves from a complex, high-dimensional Multivariate Normal distribution which depends on &lt;code&gt;\(\rho\)&lt;/code&gt; (often called the length scale parameter) to control how quickly the correlations between the model&amp;rsquo;s errors decay as a function of time. For these models, covariance decays exponentially fast with the squared distance (in time) between the observations. The functions also depend on a parameter &lt;code&gt;\(\alpha\)&lt;/code&gt;, which controls the marginal variability of the temporal function at all points; in other words it controls how much the GP term contributes to the linear predictor. &lt;code&gt;mvgam&lt;/code&gt; capitalizes on some advances that allow GPs to be approximated using Hilbert space basis functions, which &#xA;&lt;a href=&#34;https://link.springer.com/article/10.1007/s11222-022-10167-2&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;considerably speed up computation at little cost to accuracy or prediction performance&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;piecewise-logistic-and-linear-trends&#34;&gt;Piecewise logistic and linear trends&#xA;  &lt;a href=&#34;#piecewise-logistic-and-linear-trends&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;Modeling growth for many types of time series is often similar to modeling population growth in natural ecosystems, where there series exhibits nonlinear growth that saturates at some particular carrying capacity. The logistic trend model available in {&lt;code&gt;mvgam&lt;/code&gt;} allows for a time-varying capacity &lt;code&gt;\(C(t)\)&lt;/code&gt; as well as a non-constant growth rate. Changes in the base growth rate &lt;code&gt;\(k\)&lt;/code&gt; are incorporated by explicitly defining changepoints throughout the training period where the growth rate is allowed to vary. The changepoint vector &lt;code&gt;\(a\)&lt;/code&gt; is represented as a vector of &lt;code&gt;1&lt;/code&gt;s and &lt;code&gt;0&lt;/code&gt;s, and the rate of growth at time &lt;code&gt;\(t\)&lt;/code&gt; is represented as &lt;code&gt;\(k+a(t)^T\delta\)&lt;/code&gt;. Potential changepoints are selected uniformly across the training period, and the number of changepoints, as well as the flexibility of the potential rate changes at these changepoints, can be controlled using &lt;code&gt;trend_model = PW()&lt;/code&gt;. The full piecewise logistic growth model is then:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z_t &amp;amp; = \frac{C_t}{1 + \exp(-(k+a(t)^T\delta)(t-(m+a(t)^T\gamma)))}  \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;For time series that do not appear to exhibit saturating growth, a piece-wise constant rate of growth can often provide a useful trend model. The piecewise linear trend is defined as:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z_t &amp;amp; = (k+a(t)^T\delta)t + (m+a(t)^T\gamma)  \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;In both trend models, &lt;code&gt;\(m\)&lt;/code&gt; is an offset parameter that controls the trend intercept. Because of this parameter, it is not recommended that you include an intercept in your observation formula because this will not be identifiable. You can read about the full description of piecewise linear and logistic trends &#xA;&lt;a href=&#34;https://www.tandfonline.com/doi/abs/10.1080/00031305.2017.1380080&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;in this paper by Taylor and Letham&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Sean J. Taylor and Benjamin Letham. &amp;ldquo;&#xA;&lt;a href=&#34;https://www.tandfonline.com/doi/full/10.1080/00031305.2017.1380080&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Forecasting at scale.&lt;/a&gt;&amp;rdquo; &lt;em&gt;The American Statistician&lt;/em&gt; 72.1 (2018): 37-45.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;continuous-time-ar1-processes&#34;&gt;Continuous time AR(1) processes&#xA;  &lt;a href=&#34;#continuous-time-ar1-processes&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;Most trend models in the &lt;code&gt;mvgam()&lt;/code&gt; function expect time to be measured in regularly-spaced, discrete intervals (i.e. one measurement per week, or one per year for example). But some time series are taken at irregular intervals and we&amp;rsquo;d like to model autoregressive properties of these. The &lt;code&gt;trend_model = CAR()&lt;/code&gt; can be useful to set up these models, which currently only support autoregressive processes of order &lt;code&gt;1&lt;/code&gt;. The evolution of the latent dynamic process follows the form:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$\begin{align*}&#xD; z_{i,t} &amp;amp; \sim \text{Normal}(ar1_i^{distance} * z_{i,t-1}, \sigma_i) \end{align*}$$&lt;/code&gt;&lt;/p&gt;&#xA;&lt;p&gt;Where &lt;code&gt;\(distance\)&lt;/code&gt; is a vector of non-negative measurements of the time differences between successive observations. See &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/reference/RW.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;the &lt;strong&gt;Examples&lt;/strong&gt; section in &lt;code&gt;?CAR&lt;/code&gt;&lt;/a&gt; for an illustration of how to set these models up.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;regression-formulae&#34;&gt;Regression formulae&#xA;  &lt;a href=&#34;#regression-formulae&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;&lt;code&gt;mvgam&lt;/code&gt; supports an observation model regression formula, built off the &lt;code&gt;mgcv&lt;/code&gt; package, as well as an optional process model regression formula. The formulae supplied to &lt;code&gt;mvgam()&lt;/code&gt; are exactly like those supplied to &lt;code&gt;glm()&lt;/code&gt; except that smooth terms, &lt;code&gt;s()&lt;/code&gt;,&#xA;&lt;code&gt;te()&lt;/code&gt;, &lt;code&gt;ti()&lt;/code&gt; and &lt;code&gt;t2()&lt;/code&gt;, time-varying effects using &lt;code&gt;dynamic()&lt;/code&gt;, monotonically increasing (using &lt;code&gt;s(x, bs = &#39;moi&#39;)&lt;/code&gt;) or decreasing penalized splines (using &lt;code&gt;s(x, bs = &#39;mod&#39;)&lt;/code&gt;; see &lt;code&gt;?smooth.construct.moi.smooth.spec&lt;/code&gt; for details), as well as Gaussian Process functions using &lt;code&gt;gp()&lt;/code&gt;, can be added to the right hand side (and &lt;code&gt;.&lt;/code&gt; is not supported in &lt;code&gt;mvgam&lt;/code&gt; formulae). See &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/reference/mvgam_formulae.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;?mvgam_formulae&lt;/code&gt;&lt;/a&gt; for more guidance.&lt;/p&gt;&#xA;&lt;p&gt;For setting up State-Space models, the optional process model formula can be used (see &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/articles/trend_formulas.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;the State-Space model vignette&lt;/a&gt; and &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/articles/trend_formulas.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;the shared latent states vignette&lt;/a&gt; for guidance on using trend formulae).&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;see-the-cheatsheet-for-a-workflow-overview&#34;&gt;See the cheatsheet for a workflow overview&#xA;  &lt;a href=&#34;#see-the-cheatsheet-for-a-workflow-overview&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;&#xA;&lt;a href=&#34;https://github.com/nicholasjclark/mvgam/raw/master/misc/mvgam_cheatsheet.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;img src=&#34;https://github.com/nicholasjclark/mvgam/raw/master/misc/mvgam_cheatsheet.png&#34; alt=&#34;mvgam usage cheatsheet&#34;&gt;&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;future-plans&#34;&gt;Future plans&#xA;  &lt;a href=&#34;#future-plans&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;I have several priorities to help improve the workflow of &lt;code&gt;mvgam&lt;/code&gt;, as well as some features I would like to implement. These include&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Converting all graphics to &lt;code&gt;ggplot2&lt;/code&gt; so that users can modify figures as they wish&lt;/li&gt;&#xA;&lt;li&gt;Incorporating options for hierarchical modelling of dynamic process parameters (such as &lt;code&gt;\(\sigma\)&lt;/code&gt; parameters in AR or RW processes)&lt;/li&gt;&#xA;&lt;li&gt;Adding support for zero-inflated observation models&lt;/li&gt;&#xA;&lt;li&gt;Adding support for more flexible predictor effects including correlated random effects, hierarchical GPs with shared length scales &lt;code&gt;\(\rho\)&lt;/code&gt; and dynamic factor spatiotemporal effects&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;</description>
  </item>
<item>
  <title>mvgam</title>
  <link>https://ecogambler.netlify.app/project/mvgam/</link>
  <pubDate>Tue, 12 Mar 2024 00:00:00 +0000</pubDate>
<guid>https://ecogambler.netlify.app/project/mvgam/</guid>
  <description>&lt;p&gt;The goal of mvgam is to use a Bayesian framework to estimate parameters of Dynamic Generalized Additive Models (DGAMs) for time series with dynamic trend components. The package provides an interface to fit Bayesian DGAMs using either &#xA;&lt;a href=&#34;https://mcmc-jags.sourceforge.io/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;JAGS&lt;/code&gt;&lt;/a&gt; or &#xA;&lt;a href=&#34;https://mc-stan.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;Stan&lt;/code&gt;&lt;/a&gt; as the backend, but note that users are strongly encouraged to opt for Stan over JAGS. The formula syntax is based on that of the package &#xA;&lt;a href=&#34;https://cran.r-project.org/web/packages/mgcv/index.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;mgcv&lt;/code&gt;&lt;/a&gt; to provide a familiar GAM modelling interface. There is also built-in support for the increasingly powerful &#xA;&lt;a href=&#34;https://marginaleffects.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;&lt;code&gt;marginaleffects&lt;/code&gt; package&lt;/a&gt; to make interpretation easy. The motivation for the package and some of its primary objectives are described in detail by Clark &amp;amp; Wells 2022 (published in &#xA;&lt;a href=&#34;https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13974&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Methods in Ecology and Evolution&lt;/a&gt;). An introduction to the package and some worked examples are also shown in the below seminar:&lt;/p&gt;&#xA;&lt;p&gt;&lt;strong&gt;Ecological Forecasting with Dynamic Generalized Additive Models DGAMs)&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;div style=&#34;position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;&#34;&gt;&#xA;  &lt;iframe src=&#34;https://www.youtube-nocookie.com/embed/0zZopLlomsQ&#34; style=&#34;position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;&#34; allowfullscreen title=&#34;YouTube Video&#34;&gt;&lt;/iframe&gt;&#xA;&lt;/div&gt;&#xA;</description>
  </item>
<item>
  <title>Distributed lags (and hierarchical distributed lags) using mgcv and mvgam</title>
  <link>https://ecogambler.netlify.app/blog/distributed-lags-mgcv/</link>
  <pubDate>Tue, 15 Aug 2023 00:00:00 +0000</pubDate>
<guid>https://ecogambler.netlify.app/blog/distributed-lags-mgcv/</guid>
  <description>&lt;p&gt;Here we will use &lt;code&gt;mgcv&lt;/code&gt; to estimate parameters of nonlinear distributed lag models. These models are used to describe simultaneously non-linear and delayed functional relationships between a covariate and a response, and are sometimes referred to as exposure-lag-response models. If we assume &lt;code&gt;\(\tilde{\boldsymbol{y}}_{t}\)&lt;/code&gt; is the conditional expectation of a response variable &lt;code&gt;\(\boldsymbol{y}\)&lt;/code&gt; at time &lt;code&gt;\(\boldsymbol{t}\)&lt;/code&gt;, and that &lt;code&gt;\(g\)&lt;/code&gt; is a suitable inverse link function, the linear predictor for a distributed lag GAM with one lagged covariate is written as:&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;$$g(\tilde{\boldsymbol{y}}_{t})={\boldsymbol{B}}_0+\sum\limits_{k=1}^K{f}(\boldsymbol{b}_{k,t}\boldsymbol{x}_{k,t})\,$$&lt;/code&gt;&#xA;where &lt;code&gt;\(\boldsymbol{B}_{0}\)&lt;/code&gt; is the unknown intercept and the &lt;code&gt;\(\boldsymbol{b}\)&lt;/code&gt;&amp;rsquo;s are unknown spline coefficients estimating how the functional effect of covariate &lt;code&gt;\(\boldsymbol{x}\)&lt;/code&gt; on &lt;code&gt;\(g(\tilde{\boldsymbol{y}}_{t})\)&lt;/code&gt; changes over increasing lags (up to a maximum lag of &lt;code&gt;\(\boldsymbol{K}\)&lt;/code&gt;).&lt;/p&gt;&#xA;&lt;p&gt;We will work with time series of rodent captures from the Portal Project, &#xA;&lt;a href=&#34;https://portal.weecology.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a long-term monitoring study based near the town of Portal, Arizona&lt;/a&gt;. Researchers have been operating a standardized set of baited traps within 24 experimental plots at this site since the 1970&amp;rsquo;s. Sampling follows the lunar monthly cycle, with observations occurring on average about 28 days apart. However, missing observations do occur due to difficulties accessing the site (weather events, COVID disruptions etc..). You can read about the full sampling protocol &#xA;&lt;a href=&#34;https://www.biorxiv.org/content/10.1101/332783v3.full&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;in this preprint by Ernest et al on the Biorxiv&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;portal_plots.jpg&#34; alt=&#34;Portal Project sampling scheme in the desert near Portal, Arizona, USA; photo by SKM Ernest&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;environment-setup&#34;&gt;Environment setup&#xA;  &lt;a href=&#34;#environment-setup&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;This tutorial relies on the following packages:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(mvgam)           &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Fit, interrogate and forecast DGAMs&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(dplyr)           &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Tidy and flexible data manipulation&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(ggplot2)         &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Flexible plotting&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(gratia)          &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Graceful plotting of smooth terms&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(viridis)         &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Plotting colours&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(patchwork)       &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Combining ggplot objects&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;A custom &lt;code&gt;ggplot2&lt;/code&gt; theme; feel free to ignore if you have your own plot preferences&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme_set&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme_classic&lt;/span&gt;(base_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;, base_family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;serif&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme&lt;/span&gt;(axis.line.x.bottom &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;element_line&lt;/span&gt;(colour &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;black&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                                    size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  axis.line.y.left &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;element_line&lt;/span&gt;(colour &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;black&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                                  size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.&#xD;&#xA;## ℹ Please use the `linewidth` argument instead.&#xD;&#xA;## This warning is displayed once every 8 hours.&#xD;&#xA;## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was&#xD;&#xA;## generated.&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;options&lt;/span&gt;(ggplot2.discrete.colour &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                    &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#8F2727&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                    &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                    &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#630000&amp;#34;&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ggplot2.discrete.fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                  &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#8F2727&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                  &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                  &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#630000&amp;#34;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;load-and-inspect-the-portal-data&#34;&gt;Load and inspect the Portal data&#xA;  &lt;a href=&#34;#load-and-inspect-the-portal-data&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;All data from the Portal Project are made openly available in near real-time so that they can provide the maximum benefit to scientific research and outreach (&#xA;&lt;a href=&#34;https://www.weecology.org/software-projects/portalr/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a set of open-source software tools make data readily accessible&lt;/a&gt;). These data are extremely rich, containing monthly counts of rodent captures for &amp;gt;20 species. But rather than accessing the raw data, we will use some data that I have already processed and put into a simple, usable form&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;read.csv&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;https://raw.githubusercontent.com/nicholasjclark/EFI_seminar/main/data/portal_data.csv&amp;#39;&lt;/span&gt;, as.is &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#999&#34;&gt;T&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Inspect the data structure, which contains lunar monthly total captures across control plots for four different rodent species. It also contains a 12-month moving average of the unitless NDVI vegetation index, and monthly average minimum temperature (already scaled to unit variance)&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;glimpse&lt;/span&gt;(portal_ts)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Rows: 320&#xD;&#xA;## Columns: 5&#xD;&#xA;## $ captures  &amp;lt;int&amp;gt; 20, 2, 0, 0, NA, NA, NA, NA, 36, 5, 0, 0, 40, 3, 0, 1, 29, 3…&#xD;&#xA;## $ time      &amp;lt;int&amp;gt; 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, …&#xD;&#xA;## $ species   &amp;lt;chr&amp;gt; &amp;#34;DM&amp;#34;, &amp;#34;DO&amp;#34;, &amp;#34;PB&amp;#34;, &amp;#34;PP&amp;#34;, &amp;#34;DM&amp;#34;, &amp;#34;DO&amp;#34;, &amp;#34;PB&amp;#34;, &amp;#34;PP&amp;#34;, &amp;#34;DM&amp;#34;, &amp;#34;DO&amp;#34;, …&#xD;&#xA;## $ ndvi_ma12 &amp;lt;dbl&amp;gt; -0.172144125, -0.172144125, -0.172144125, -0.172144125, -0.2…&#xD;&#xA;## $ mintemp   &amp;lt;dbl&amp;gt; -0.79633807, -0.79633807, -0.79633807, -0.79633807, -1.33471…&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The data contain 80 lunar monthly observations, though there are plenty of NAs in the number of total captures (NAs are shown as red bars in the below plot)&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(portal_ts&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] 80&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;image&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;is.na&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;t&lt;/span&gt;(portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;arrange&lt;/span&gt;(dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;desc&lt;/span&gt;(time)))), axes &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#999&#34;&gt;F&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;grey80&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;axis&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;, at &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, len &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NCOL&lt;/span&gt;(portal_ts)), &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     labels &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;colnames&lt;/span&gt;(portal_ts))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-6-1.png&#34; alt=&#34;Visualising features of time series data in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;The data are already in &amp;rsquo;long&amp;rsquo; format, meaning each series x time observation has its own entry in the &lt;code&gt;data.frame&lt;/code&gt;. But {&lt;code&gt;mvgam&lt;/code&gt;} needs a &lt;code&gt;series&lt;/code&gt; column that acts as a factor indicator for the time series. Add one using {&lt;code&gt;dplyr&lt;/code&gt;} commands:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.factor&lt;/span&gt;(species)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&amp;gt;&lt;/span&gt; portal_ts&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;glimpse&lt;/span&gt;(portal_ts)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Rows: 320&#xD;&#xA;## Columns: 6&#xD;&#xA;## $ captures  &amp;lt;int&amp;gt; 20, 2, 0, 0, NA, NA, NA, NA, 36, 5, 0, 0, 40, 3, 0, 1, 29, 3…&#xD;&#xA;## $ time      &amp;lt;int&amp;gt; 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, …&#xD;&#xA;## $ species   &amp;lt;chr&amp;gt; &amp;#34;DM&amp;#34;, &amp;#34;DO&amp;#34;, &amp;#34;PB&amp;#34;, &amp;#34;PP&amp;#34;, &amp;#34;DM&amp;#34;, &amp;#34;DO&amp;#34;, &amp;#34;PB&amp;#34;, &amp;#34;PP&amp;#34;, &amp;#34;DM&amp;#34;, &amp;#34;DO&amp;#34;, …&#xD;&#xA;## $ ndvi_ma12 &amp;lt;dbl&amp;gt; -0.172144125, -0.172144125, -0.172144125, -0.172144125, -0.2…&#xD;&#xA;## $ mintemp   &amp;lt;dbl&amp;gt; -0.79633807, -0.79633807, -0.79633807, -0.79633807, -1.33471…&#xD;&#xA;## $ series    &amp;lt;fct&amp;gt; DM, DO, PB, PP, DM, DO, PB, PP, DM, DO, PB, PP, DM, DO, PB, …&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;levels&lt;/span&gt;(portal_ts&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] &amp;#34;DM&amp;#34; &amp;#34;DO&amp;#34; &amp;#34;PB&amp;#34; &amp;#34;PP&amp;#34;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It is important that the number of levels matches the number of unique series in the data to ensure indexing across series works properly in the underlying modelling functions. For more information on how to format data for {&lt;code&gt;mvgam&lt;/code&gt;} modelling, see &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/articles/data_in_mvgam.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;the data formatting vignette in the package&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;Now we can plot all of the time series together, using the &lt;code&gt;captures&lt;/code&gt; measurement as our outcome variable&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;captures&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;all&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-8-1.png&#34; alt=&#34;Visualising features of time series data in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;We can also plot some more in-depth features for individual series&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;captures&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-9-1.png&#34; alt=&#34;Visualising features of time series data in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;captures&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-9-2.png&#34; alt=&#34;Visualising features of time series data in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;captures&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-9-3.png&#34; alt=&#34;Visualising features of time series data in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_mvgam_series&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;captures&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-9-4.png&#34; alt=&#34;Visualising features of time series data in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Inspect some associations between &lt;code&gt;log(captures + 1)&lt;/code&gt; and minimum temperature / NDVI moving average for each species to get a sense of how their relative abundances vary over seasons and with varying habitat conditions. First for &lt;strong&gt;DM&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;DM&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mintemp, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;log&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;(method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;gam&amp;#34;&lt;/span&gt;, formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(x, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(title &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;DM&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;log(captures)&amp;#34;&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Minimum temperature&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;DM&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; ndvi_ma12, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;log&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;(method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;gam&amp;#34;&lt;/span&gt;, formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(x, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NULL&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;NDVI moving average&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing non-finite outside the scale range&#xD;&#xA;## (`stat_smooth()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing missing values or values outside the scale range&#xD;&#xA;## (`geom_point()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing non-finite outside the scale range&#xD;&#xA;## (`stat_smooth()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing missing values or values outside the scale range&#xD;&#xA;## (`geom_point()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-10-1.png&#34; alt=&#34;Visualising features of time series data in ggplot2 and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;And for &lt;strong&gt;PP&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PP&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mintemp, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;log&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;(method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;gam&amp;#34;&lt;/span&gt;, formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(x, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(title &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PP&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;log(captures)&amp;#34;&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Minimum temperature&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PP&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; ndvi_ma12, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;log&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;(method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;gam&amp;#34;&lt;/span&gt;, formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(x, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NULL&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;NDVI moving average&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing non-finite outside the scale range&#xD;&#xA;## (`stat_smooth()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing missing values or values outside the scale range&#xD;&#xA;## (`geom_point()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing non-finite outside the scale range&#xD;&#xA;## (`stat_smooth()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing missing values or values outside the scale range&#xD;&#xA;## (`geom_point()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-11-1.png&#34; alt=&#34;Visualising features of time series data in ggplot2 and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Next for &lt;strong&gt;PB&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PB&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mintemp, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;log&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;(method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;gam&amp;#34;&lt;/span&gt;, formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(x, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(title &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PB&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;log(captures)&amp;#34;&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Minimum temperature&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PB&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; ndvi_ma12, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;log&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;(method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;gam&amp;#34;&lt;/span&gt;, formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(x, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NULL&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;NDVI moving average&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing non-finite outside the scale range&#xD;&#xA;## (`stat_smooth()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing missing values or values outside the scale range&#xD;&#xA;## (`geom_point()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing non-finite outside the scale range&#xD;&#xA;## (`stat_smooth()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing missing values or values outside the scale range&#xD;&#xA;## (`geom_point()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-12-1.png&#34; alt=&#34;Visualising features of time series data in ggplot2 and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;And finally for &lt;strong&gt;DO&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;DO&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mintemp, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;log&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;(method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;gam&amp;#34;&lt;/span&gt;, formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(x, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(title &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;DO&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;log(captures)&amp;#34;&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Minimum temperature&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;DO&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; ndvi_ma12, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;log&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;))) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;(method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;gam&amp;#34;&lt;/span&gt;, formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(x, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NULL&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;NDVI moving average&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing non-finite outside the scale range&#xD;&#xA;## (`stat_smooth()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing missing values or values outside the scale range&#xD;&#xA;## (`geom_point()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing non-finite outside the scale range&#xD;&#xA;## (`stat_smooth()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Warning: Removed 17 rows containing missing values or values outside the scale range&#xD;&#xA;## (`geom_point()`).&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-13-1.png&#34; alt=&#34;Visualising features of time series data in ggplot2 and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;There may be some support for some nonlinear effects here, but we know that the rodents in this system do not show immediate responses to climatic or environmental changes. Rather, these responses are often &lt;em&gt;delayed&lt;/em&gt;, and can be thought of as &lt;em&gt;cumulative&lt;/em&gt; responses to varying conditions over a period of months. How can we capture these effects using GAMs? This is where distributed lag models come in.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;setting-up-lag-matrices&#34;&gt;Setting up lag matrices&#xA;  &lt;a href=&#34;#setting-up-lag-matrices&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;A lesser-known feature of &lt;code&gt;mgcv&lt;/code&gt; is its ability to handle data in &lt;code&gt;list&lt;/code&gt; format as opposed to the traditional &lt;code&gt;data.frame&lt;/code&gt; format that most regression packages in R use. This allows us to supply some (or all) of our covariates as &lt;code&gt;matrices&lt;/code&gt; rather than &lt;code&gt;vectors&lt;/code&gt;, and opens many possibilities for more complex modeling. You can read a bit more about this using &lt;code&gt;?gam.models&lt;/code&gt; and looking at the section on &lt;strong&gt;Linear functional terms&lt;/strong&gt;. We can make use of this to set up the objects needed for estimating nonlinear distributed lag functions.&lt;/p&gt;&#xA;&lt;p&gt;Below is an exact reproduction of Simon Wood&amp;rsquo;s lag matrix function (which he uses in his distributed lag example from his book &#xA;&lt;a href=&#34;https://www.taylorfrancis.com/books/mono/10.1201/9781315370279/generalized-additive-models-simon-wood&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Generalized Additive Models - An Introduction with R 2nd edition&lt;/a&gt;). To use this function we need to supply a vector and specify the maximum lag that we want, and it will return a matrix of dimension &lt;code&gt;length(x) * lag&lt;/code&gt;. Note that &lt;code&gt;NAs&lt;/code&gt; are used for the missing lag values at the beginning of the matrix. In essence, the matrix objects represent exposure histories, where each row represents the lagged values of the predictor that correspond to each observation in our outcome variable. By creating a &lt;em&gt;tensor product&lt;/em&gt; of this lagged covariate matrix and a matrix of equal dimensions that indicates which lag each cell in the covariate matrix represents, we can effectively set up a function that changes nonlinearly over lagged values of the covariate.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;lagard &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x, n_lag &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;) {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  n &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(x)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  X &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NA&lt;/span&gt;, n, n_lag)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt; (i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;n_lag){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    X[i&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;n, i] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; x[i&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;n &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&lt;/span&gt; i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;]&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  } &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  X&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We can make use of this function to organise all data needed for modeling into a list. For this simple example we will use lags of up to six months in the past. Some bookkeeping is necessary, as we must ensure that we remove the first five observations &lt;em&gt;for each series&lt;/em&gt;. This is best achieved by arranging the data by &lt;code&gt;series&lt;/code&gt; and then by &lt;code&gt;time&lt;/code&gt;. I do this first to create the &lt;code&gt;mintemp&lt;/code&gt; matrix&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mintemp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;do.call&lt;/span&gt;(rbind, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lapply&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq_along&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;levels&lt;/span&gt;(portal_ts&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series)), &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;levels&lt;/span&gt;(portal_ts&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series)[x]) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;arrange&lt;/span&gt;(time) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;select&lt;/span&gt;(mintemp, time) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;pull&lt;/span&gt;(mintemp) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&amp;gt;&lt;/span&gt; tempdat&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  lag_mat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lagard&lt;/span&gt;(tempdat, &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;tail&lt;/span&gt;(lag_mat, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NROW&lt;/span&gt;(lag_mat) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;dim&lt;/span&gt;(mintemp)[1]&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] 300&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The lagged &lt;code&gt;mintemp&lt;/code&gt; matrix now looks like this:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;head&lt;/span&gt;(mintemp, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;##              [,1]        [,2]        [,3]        [,4]        [,5]        [,6]&#xD;&#xA;##  [6,]  0.06532892 -0.42447625 -1.08048145 -1.24166462 -1.33471597 -0.79633807&#xD;&#xA;##  [7,]  0.82279570  0.06532892 -0.42447625 -1.08048145 -1.24166462 -1.33471597&#xD;&#xA;##  [8,]  1.16043027  0.82279570  0.06532892 -0.42447625 -1.08048145 -1.24166462&#xD;&#xA;##  [9,]  1.35620578  1.16043027  0.82279570  0.06532892 -0.42447625 -1.08048145&#xD;&#xA;## [10,]  1.25417764  1.35620578  1.16043027  0.82279570  0.06532892 -0.42447625&#xD;&#xA;## [11,]  1.15421766  1.25417764  1.35620578  1.16043027  0.82279570  0.06532892&#xD;&#xA;## [12,] -0.17521991  1.15421766  1.25417764  1.35620578  1.16043027  0.82279570&#xD;&#xA;## [13,] -0.65285556 -0.17521991  1.15421766  1.25417764  1.35620578  1.16043027&#xD;&#xA;## [14,] -1.47224270 -0.65285556 -0.17521991  1.15421766  1.25417764  1.35620578&#xD;&#xA;## [15,] -1.26667509 -1.47224270 -0.65285556 -0.17521991  1.15421766  1.25417764&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now we can arrange the data in the same way and pull necessary objects into the &lt;code&gt;list&lt;/code&gt;:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;portal_ts &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;arrange&lt;/span&gt;(series, time) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;filter&lt;/span&gt;(time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&amp;gt;&lt;/span&gt; portal_ts&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;data_all &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;list&lt;/span&gt;(&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  lag &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;nrow&lt;/span&gt;(portal_ts), &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;, byrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;captures,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  ndvi_ma12 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;ndvi_ma12,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; portal_ts&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;And add the &lt;code&gt;mintemp&lt;/code&gt; history matrix:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mintemp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; mintemp&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The lag exposure history matrix looks as follows:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;head&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag, &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;##      [,1] [,2] [,3] [,4] [,5] [,6]&#xD;&#xA;## [1,]    0    1    2    3    4    5&#xD;&#xA;## [2,]    0    1    2    3    4    5&#xD;&#xA;## [3,]    0    1    2    3    4    5&#xD;&#xA;## [4,]    0    1    2    3    4    5&#xD;&#xA;## [5,]    0    1    2    3    4    5&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;All other elements of the data list are in the usual vector format&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;head&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;captures, &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] 25 29 23 22 NA&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;head&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series, &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] DM DM DM DM DM&#xD;&#xA;## Levels: DM DO PB PP&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;head&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time, &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1]  6  7  8  9 10&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The dimensions of all the objects need to match up&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;dim&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] 300   6&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;dim&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mintemp)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] 300   6&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## [1] 300&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;fitting-a-distributed-lag-model-for-one-species&#34;&gt;Fitting a distributed lag model for one species&#xA;  &lt;a href=&#34;#fitting-a-distributed-lag-model-for-one-species&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The setup we have now is fine for fitting a distributed lag model to captures of just a single species. To illustrate how this works and what these models estimate, we can subset the data to only include observations for &lt;strong&gt;PP&lt;/strong&gt;:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;pp_inds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;which&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PP&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;data_pp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lapply&lt;/span&gt;(data_all, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;if&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;is.matrix&lt;/span&gt;(x)){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    x[pp_inds, ]&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  } &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;else&lt;/span&gt; {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    x[pp_inds]&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;})&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Setting up the model is now very straightforward. We simply wrap the &lt;code&gt;lag&lt;/code&gt; and &lt;code&gt;mintemp&lt;/code&gt; matrices in a call to &lt;code&gt;te()&lt;/code&gt;, which will set up a tensor product smoother (see &lt;code&gt;?mgcv::te&lt;/code&gt; for details). I also use a smooth term for &lt;code&gt;ndvi_ma12&lt;/code&gt; in this model, and stick with a Poisson observation model to keep things simple&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(ndvi_ma12),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;poisson&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; data_pp,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;summary&lt;/span&gt;(mod1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## &#xD;&#xA;## Family: poisson &#xD;&#xA;## Link function: log &#xD;&#xA;## &#xD;&#xA;## Formula:&#xD;&#xA;## captures ~ te(mintemp, lag, k = 6) + s(ndvi_ma12)&#xD;&#xA;## &#xD;&#xA;## Parametric coefficients:&#xD;&#xA;##             Estimate Std. Error z value Pr(&amp;gt;|z|)    &#xD;&#xA;## (Intercept)  1.36702    0.07786   17.56   &amp;lt;2e-16 ***&#xD;&#xA;## ---&#xD;&#xA;## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1&#xD;&#xA;## &#xD;&#xA;## Approximate significance of smooth terms:&#xD;&#xA;##                    edf Ref.df Chi.sq p-value    &#xD;&#xA;## te(mintemp,lag) 19.009 21.686 127.94  &amp;lt;2e-16 ***&#xD;&#xA;## s(ndvi_ma12)     4.169  5.075  13.06  0.0219 *  &#xD;&#xA;## ---&#xD;&#xA;## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1&#xD;&#xA;## &#xD;&#xA;## Rank: 44/45&#xD;&#xA;## R-sq.(adj) =   0.62   Deviance explained =   69%&#xD;&#xA;## -REML = 180.09  Scale est. = 1         n = 59&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;There will surely be autocorrelation left in the residuals from this model, but we will ignore that for now and focus on how to interpret the distributed lag term. Plotting these terms is easy with &lt;code&gt;mgcv&lt;/code&gt;:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mod1, select &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, scheme &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-24-1.png&#34; alt=&#34;Visualising distributed lag smooths in mgcv and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Here the brighter yellow colours indicate larger linear predictor values, while the darker red colours indicate smaller linear predictor values. We can get a nicer plot of this effect using &#xA;&lt;a href=&#34;https://gavinsimpson.github.io/gratia/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Gavin Simpson&amp;rsquo;s {&lt;code&gt;gratia&lt;/code&gt;} package&lt;/a&gt;. Note, I am currently using the development version of this package that was recently installed from Github. This is necessary for accurate plots of nonlinear functionals that include &lt;code&gt;by&lt;/code&gt; terms (use &lt;code&gt;devtools::install_github(&#39;gavinsimpson/gratia&#39;)&lt;/code&gt; to get the latest version)&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;draw&lt;/span&gt;(mod1, select &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-25-1.png&#34; alt=&#34;Visualising distributed lag smooths in mgcv and Gavin Simpson&#39;s gratia package in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;To me these bivariate heatmaps are a bit difficult to interpret, but more on that later.&lt;/p&gt;&#xA;&lt;p&gt;Clearly there is support for a nonlinear effect of &lt;code&gt;mintemp&lt;/code&gt; that changes over different lags, which is sensible given what we know about population dynamics in this system. But how can we incorporate such effects for &lt;em&gt;all species&lt;/em&gt; in the model at once? The &lt;code&gt;by&lt;/code&gt; argument in &lt;code&gt;mgcv&lt;/code&gt; parlance can frequently be used to set up smoothers that vary across levels of a factor, and there are many extremely useful strategies for setting up hierarchical GAMs (&#xA;&lt;a href=&#34;https://peerj.com/articles/6876/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;see this paper by Pedersen et al for some more context and many useful examples&lt;/a&gt;). But this option doesn&amp;rsquo;t work when we are dealing with covariates that are stored in &lt;code&gt;matrix&lt;/code&gt; format. In fact, there was &#xA;&lt;a href=&#34;https://stackoverflow.com/questions/75376475/gam-distributed-lag-model-with-factor-smooth-interaction-by-variable&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a recent post on StackOverflow asking about this very issue&lt;/a&gt;:&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;stackoverflow_shot.png&#34; alt=&#34;StackOverflow request for help on setting up factor interactions for distributed lag effects&#34;&gt;&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;group-level-and-hierarchical-distributed-lags&#34;&gt;Group-level and hierarchical distributed lags&#xA;  &lt;a href=&#34;#group-level-and-hierarchical-distributed-lags&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;I banged my head against the desk for several hours trying to fit hierarchical distributed lag models in {&lt;code&gt;mgcv&lt;/code&gt;} for &#xA;&lt;a href=&#34;https://github.com/nicholasjclark/portal_VAR&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;a recent paper using these very data&lt;/a&gt;. So I know exactly how the author of this post feels. Fortunately, I discovered that they are possible. The key of course is to carefully read the {&lt;code&gt;mgcv&lt;/code&gt;} documentation. If you look at the help for linear functionals (&lt;code&gt;?mgcv::linear.functional.terms&lt;/code&gt; and &lt;code&gt;?mgcv::gam.models&lt;/code&gt;), you will see that the &lt;code&gt;by&lt;/code&gt; variable is used in these cases as a &lt;em&gt;weighting matrix&lt;/em&gt;. The resulting smooth is therefore constructed as &lt;code&gt;rowSums(L * F)&lt;/code&gt;, where &lt;code&gt;F&lt;/code&gt; is the distributed lag smooth and &lt;code&gt;L&lt;/code&gt; is the weighting matrix. After reading this (several times) I finally realised that I needed to supply group-level distributed lag terms &lt;em&gt;for each group&lt;/em&gt; in the formula. In short, we can create weight matrices for each level of the grouping factor to set up group-level and hierarchical distributed lag terms by doing this:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;weights_dm &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; weights_do &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; weights_pb &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; weights_pp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ncol&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag), nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;nrow&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;What we now have is a weighting matrix for each level of the grouping factor. Currently the weights are all set to &lt;code&gt;1&lt;/code&gt; for each row of the data:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;head&lt;/span&gt;(weights_dm)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;##      [,1] [,2] [,3] [,4] [,5] [,6]&#xD;&#xA;## [1,]    1    1    1    1    1    1&#xD;&#xA;## [2,]    1    1    1    1    1    1&#xD;&#xA;## [3,]    1    1    1    1    1    1&#xD;&#xA;## [4,]    1    1    1    1    1    1&#xD;&#xA;## [5,]    1    1    1    1    1    1&#xD;&#xA;## [6,]    1    1    1    1    1    1&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;But to set up the appropriate group-level tensor products, we need to change these appropriately. Essentially, for each level in the grouping factor, the rows in that level&amp;rsquo;s corresponding weighting matrix need to have &lt;code&gt;1&lt;/code&gt;s when the corresponding observation in the data matches that level, and &lt;code&gt;0&lt;/code&gt;s otherwise:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;weights_dm[&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;DM&amp;#39;&lt;/span&gt;), ] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;weights_do[&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;DO&amp;#39;&lt;/span&gt;), ] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;weights_pb[&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PB&amp;#39;&lt;/span&gt;), ] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;weights_pp[&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;!&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;PP&amp;#39;&lt;/span&gt;), ] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Adding these weighting matrices to the data list gives us all we need to set up group-level or hierarchical distributed lag terms&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;weights_dm &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; weights_dm&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;weights_do &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; weights_do&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;weights_pb &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; weights_pb&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;weights_pp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; weights_pp&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s try it out! We will fit a multispecies GAM that includes distributed lag terms of &lt;code&gt;mintemp&lt;/code&gt; for each species. It will also smooths of &lt;code&gt;ndvi_ma12&lt;/code&gt; for each species, random intercepts for each species and smooths of &lt;code&gt;time&lt;/code&gt; for each species. Again this model is probably not completely appropriate because it doesn&amp;rsquo;t take temporal autocorrelation into account very well (though the smooths of &lt;code&gt;time&lt;/code&gt; will help), but it is useful to illustrate some of these principles&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Hierarchical intercepts&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(series, bs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;re&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Smooths of time to try and capture autocorrelation&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; series, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;30&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Smooths of ndvi_ma12&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(ndvi_ma12, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; series, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Distributed lags of mintemp&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; weights_dm) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; weights_do) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; weights_pb) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; weights_pp),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;poisson&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; data_all,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            control &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;list&lt;/span&gt;(nthreads &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;summary&lt;/span&gt;(mod2)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## &#xD;&#xA;## Family: poisson &#xD;&#xA;## Link function: log &#xD;&#xA;## &#xD;&#xA;## Formula:&#xD;&#xA;## captures ~ s(series, bs = &amp;#34;re&amp;#34;) + s(time, by = series, k = 30) + &#xD;&#xA;##     s(ndvi_ma12, by = series, k = 5) + te(mintemp, lag, k = 4, &#xD;&#xA;##     by = weights_dm) + te(mintemp, lag, k = 4, by = weights_do) + &#xD;&#xA;##     te(mintemp, lag, k = 4, by = weights_pb) + te(mintemp, lag, &#xD;&#xA;##     k = 4, by = weights_pp)&#xD;&#xA;## &#xD;&#xA;## Parametric coefficients:&#xD;&#xA;##             Estimate Std. Error z value Pr(&amp;gt;|z|)&#xD;&#xA;## (Intercept)   0.0374     0.5223   0.072    0.943&#xD;&#xA;## &#xD;&#xA;## Approximate significance of smooth terms:&#xD;&#xA;##                                   edf Ref.df  Chi.sq  p-value    &#xD;&#xA;## s(series)                  -2.847e-16  4.000   0.000 0.045616 *  &#xD;&#xA;## s(time):seriesDM            3.971e+00  4.827  74.186  &amp;lt; 2e-16 ***&#xD;&#xA;## s(time):seriesDO            3.419e+00  4.173  39.097  &amp;lt; 2e-16 ***&#xD;&#xA;## s(time):seriesPB            5.460e+00  6.497  85.988  &amp;lt; 2e-16 ***&#xD;&#xA;## s(time):seriesPP            1.445e+01 17.310 100.348  &amp;lt; 2e-16 ***&#xD;&#xA;## s(ndvi_ma12):seriesDM       2.803e+00  3.268  15.759 0.002060 ** &#xD;&#xA;## s(ndvi_ma12):seriesDO       3.268e+00  3.689  10.113 0.034299 *  &#xD;&#xA;## s(ndvi_ma12):seriesPB       2.580e+00  2.993   5.629 0.140632    &#xD;&#xA;## s(ndvi_ma12):seriesPP       1.654e+00  1.929   2.139 0.268807    &#xD;&#xA;## te(mintemp,lag):weights_dm  4.614e+00  5.613  41.490 1.73e-06 ***&#xD;&#xA;## te(mintemp,lag):weights_do  4.135e+00  4.440  24.922 0.000106 ***&#xD;&#xA;## te(mintemp,lag):weights_pb  6.848e+00  8.307  19.273 0.017449 *  &#xD;&#xA;## te(mintemp,lag):weights_pp  3.000e+00  3.000  25.324 1.25e-05 ***&#xD;&#xA;## ---&#xD;&#xA;## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1&#xD;&#xA;## &#xD;&#xA;## Rank: 196/201&#xD;&#xA;## R-sq.(adj) =  0.885   Deviance explained = 89.7%&#xD;&#xA;## -REML = 557.05  Scale est. = 1         n = 236&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Again, useful plots of the these smooth terms can be made using {&lt;code&gt;gratia&lt;/code&gt;}&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;draw&lt;/span&gt;(mod2, select &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-31-1.png&#34; alt=&#34;Visualising nonlinear smooths in mgcv and Gavin Simpson&#39;s gratia package in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;draw&lt;/span&gt;(mod2, select &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;9&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-32-1.png&#34; alt=&#34;Visualising nonlinear smooths in mgcv and Gavin Simpson&#39;s gratia package in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;draw&lt;/span&gt;(mod2, select &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;13&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-33-1.png&#34; alt=&#34;Visualising distributed lag smooths in mgcv and Gavin Simpson&#39;s gratia package in R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;visualising-distributed-lag-terms&#34;&gt;Visualising distributed lag terms&#xA;  &lt;a href=&#34;#visualising-distributed-lag-terms&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;If you are like me then you&amp;rsquo;ll find these bivariate heatmap plots of the distributed lag terms rather difficult to interpret. Again, the more intense yellow/white colours indicate higher predicted values, with the deeper red colours representing lower predicted values, but actually making sense of how the functional response is expected to change over different lags is not easy from these plots. However, we can use the &lt;code&gt;predict.gam()&lt;/code&gt; function to generate much more interpretable plots. To do so, we can generate a series of conditional predictions to visualise how the estimated function of &lt;code&gt;mintemp&lt;/code&gt; changes over different lags for each species. This is done by setting up prediction data that zeros out all covariates apart from the covariate of interest. Ordinarily I&amp;rsquo;d use the wonderful &#xA;&lt;a href=&#34;https://marginaleffects.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;{&lt;code&gt;marginaleffects&lt;/code&gt;} package&lt;/a&gt; to automate this process, but unfortunately it doesn&amp;rsquo;t work with data that are in &lt;code&gt;list&lt;/code&gt; format (yet). So here is a rather lengthy function that will do the work for us. It works by iterating over lags and keeping all &lt;code&gt;mintemp&lt;/code&gt; values at zero apart from the particular lag being predicted so that we can visualise how the predicted function changes over lags of &lt;code&gt;mintemp&lt;/code&gt;. Predictions are generated on the link scale in this case, though you could also use the response scale. Note that we need to first generate predictions with all covariates (including the &lt;code&gt;mintemp&lt;/code&gt; covariate) zeroed out to find the &amp;lsquo;baseline&amp;rsquo; prediction (which will centre around the species&amp;rsquo; expected average count, on the log scale) so that we can shift by this baseline for generating a zero-centred plot. That way our resulting plot will roughly follow the traditional &lt;code&gt;mgcv&lt;/code&gt; partial effect plots&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;plot_dist_lags &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(model, data_all){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  all_species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;levels&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Loop across species to create the effect plot dataframe&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  sp_plot_dat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;do.call&lt;/span&gt;(rbind, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lapply&lt;/span&gt;(all_species, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(sp){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Zero out all predictors to start the newdata&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lapply&lt;/span&gt;(data_all, &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(x){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;if&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;is.matrix&lt;/span&gt;(x)){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;nrow&lt;/span&gt;(x), ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ncol&lt;/span&gt;(x))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      } &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;else&lt;/span&gt; {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(x))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    })&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Modify to only focus on the species of interest&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    newdata&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rep&lt;/span&gt;(sp, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;nrow&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    newdata&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    which_weightmat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;grep&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;paste0&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;weights_&amp;#39;&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                   &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;tolower&lt;/span&gt;(sp)), &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                            &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;names&lt;/span&gt;(newdata))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    newdata[[which_weightmat]] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;nrow&lt;/span&gt;(newdata[[which_weightmat]]),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                         ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ncol&lt;/span&gt;(newdata[[which_weightmat]]))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Calculate predictions for when mintemp is zero to find the baseline&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# value for centring the plot&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;if&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;inherits&lt;/span&gt;(model, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;mvgam&amp;#39;&lt;/span&gt;)){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;predict&lt;/span&gt;(model, newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; newdata, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;link&amp;#39;&lt;/span&gt;, process_error &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, median)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    } &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;else&lt;/span&gt; {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;predict&lt;/span&gt;(model, newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; newdata, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;link&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    offset &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mean&lt;/span&gt;(preds)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    plot_dat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;do.call&lt;/span&gt;(rbind, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lapply&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;), &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(lag){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Set up prediction matrix for mintemp; &lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# use a sequence of values across the full range of observed values&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      newdata&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mintemp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ncol&lt;/span&gt;(newdata&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;nrow&lt;/span&gt;(newdata&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;lag))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      newdata&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mintemp[,lag] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;min&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mintemp),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                   &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mintemp),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                   length.out &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(newdata&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Predict on the link scale and shift by the offset &lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# so that values are roughly centred at zero&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;if&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;inherits&lt;/span&gt;(model, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;mvgam&amp;#39;&lt;/span&gt;)){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;predict&lt;/span&gt;(model, newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; newdata, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;link&amp;#39;&lt;/span&gt;, process_error &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;apply&lt;/span&gt;(preds, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, median)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      } &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;else&lt;/span&gt; {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;predict&lt;/span&gt;(model, newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; newdata,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;link&amp;#39;&lt;/span&gt;) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;-&lt;/span&gt; offset&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data.frame&lt;/span&gt;(lag &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; lag,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                 preds &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; preds,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                 mintemp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;min&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mintemp),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                   &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(data_all&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;mintemp),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                   length.out &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(newdata&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time)))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    plot_dat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;species &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; sp&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    plot_dat&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Build the facetted distributed lag plot&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; sp_plot_dat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;           dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(lag &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.factor&lt;/span&gt;(lag)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mintemp, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; preds, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;             colour &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; lag, fill &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; lag)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;facet_wrap&lt;/span&gt;(&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; species, scales &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;free&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_hline&lt;/span&gt;(yintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Use geom_smooth, though beware these uncertainty&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# intervals aren&amp;#39;t necessarily correct&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_smooth&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;scale_fill_viridis&lt;/span&gt;(discrete &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;scale_colour_viridis&lt;/span&gt;(discrete &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Minimum temperature (z-scored)&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;         y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Partial effect&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Plot the conditional &lt;code&gt;mintemp&lt;/code&gt; effects for each species&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_dist_lags&lt;/span&gt;(mod2, data_all)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## `geom_smooth()` using method = &amp;#39;loess&amp;#39; and formula = &amp;#39;y ~ x&amp;#39;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-35-1.png&#34; alt=&#34;Visualising nonlinear distributed lag smooths in mgcv and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;There we have it. Now it is clear that some species show fairly strong responses to cumulative change in minimum temperature, while others do not. But the fact that we aren&amp;rsquo;t effectively capturing temporal autocorrelation could be influencing these estimates. What happens if we do model temporal dynamics appropriately?&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;using-mvgam-to-capture-dynamic-processes&#34;&gt;Using mvgam to capture dynamic processes&#xA;  &lt;a href=&#34;#using-mvgam-to-capture-dynamic-processes&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;Just as a quick illustration, I will show how the same model can be used in &lt;code&gt;mvgam&lt;/code&gt;, except that we replace the smooth functions of &lt;code&gt;time&lt;/code&gt; with more appropriate dynamic processes that can capture the temporal autocorrelation in the observations. This model uses very similar syntax to the above and can use the same data objects, so there is no need to change much here&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod3 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvgam&lt;/span&gt;(captures &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Hierarchical intercepts&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(series, bs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;re&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Smooths of ndvi_ma12&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(ndvi_ma12, by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; series, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Distributed lags of mintemp&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;), by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; weights_dm) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;), by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; weights_do) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;), by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; weights_pb) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;te&lt;/span&gt;(mintemp, lag, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;8&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;), by &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; weights_pp),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Latent dynamic processes to capture autocorrelation&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              trend_model &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;AR&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;poisson&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; data_all)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;summary&lt;/span&gt;(mod3, include_betas &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## GAM formula:&#xD;&#xA;## captures ~ s(ndvi_ma12, by = series, k = 5) + te(mintemp, lag, &#xD;&#xA;##     k = 4, by = weights_dm) + te(mintemp, lag, k = 4, by = weights_do) + &#xD;&#xA;##     te(mintemp, lag, k = 4, by = weights_pb) + te(mintemp, lag, &#xD;&#xA;##     k = 4, by = weights_pp) + s(series, bs = &amp;#34;re&amp;#34;)&#xD;&#xA;## &#xD;&#xA;## Family:&#xD;&#xA;## poisson&#xD;&#xA;## &#xD;&#xA;## Link function:&#xD;&#xA;## log&#xD;&#xA;## &#xD;&#xA;## Trend model:&#xD;&#xA;## AR()&#xD;&#xA;## &#xD;&#xA;## N series:&#xD;&#xA;## 4 &#xD;&#xA;## &#xD;&#xA;## N timepoints:&#xD;&#xA;## 80 &#xD;&#xA;## &#xD;&#xA;## Status:&#xD;&#xA;## Fitted using Stan &#xD;&#xA;## 4 chains, each with iter = 1000; warmup = 500; thin = 1 &#xD;&#xA;## Total post-warmup draws = 2000&#xD;&#xA;## &#xD;&#xA;## &#xD;&#xA;## GAM coefficient (beta) estimates:&#xD;&#xA;##              2.5% 50% 97.5% Rhat n_eff&#xD;&#xA;## (Intercept) -0.73 1.6   3.7    1  1478&#xD;&#xA;## &#xD;&#xA;## GAM group-level estimates:&#xD;&#xA;##                  2.5%   50% 97.5% Rhat n_eff&#xD;&#xA;## mean(s(series)) -1.80 0.013   1.8 1.00  2446&#xD;&#xA;## sd(s(series))    0.33 1.300   3.6 1.02   632&#xD;&#xA;## &#xD;&#xA;## Approximate significance of GAM smooths:&#xD;&#xA;##                              edf Ref.df Chi.sq p-value&#xD;&#xA;## s(ndvi_ma12):seriesDM      1.093      4   8.82     1.0&#xD;&#xA;## s(ndvi_ma12):seriesDO      1.048      4   2.93     1.0&#xD;&#xA;## s(ndvi_ma12):seriesPB      0.889      4   0.18     1.0&#xD;&#xA;## s(ndvi_ma12):seriesPP      1.037      4   3.30     1.0&#xD;&#xA;## te(mintemp,lag):weights_dm 8.649     16  11.57     1.0&#xD;&#xA;## te(mintemp,lag):weights_do 5.059     16  29.12     1.0&#xD;&#xA;## te(mintemp,lag):weights_pb 5.715     16  13.49     1.0&#xD;&#xA;## te(mintemp,lag):weights_pp 6.973     16 144.90     1.0&#xD;&#xA;## s(series)                  2.137      4  31.88     0.2&#xD;&#xA;## &#xD;&#xA;## Latent trend parameter AR estimates:&#xD;&#xA;##           2.5%  50% 97.5% Rhat n_eff&#xD;&#xA;## ar1[1]   0.760 0.95  1.00 1.04   144&#xD;&#xA;## ar1[2]   0.800 0.95  1.00 1.01   404&#xD;&#xA;## ar1[3]   0.850 0.96  1.00 1.00   651&#xD;&#xA;## ar1[4]   0.670 0.86  0.98 1.01   693&#xD;&#xA;## sigma[1] 0.075 0.14  0.24 1.07   105&#xD;&#xA;## sigma[2] 0.150 0.28  0.49 1.03   111&#xD;&#xA;## sigma[3] 0.270 0.47  0.72 1.02   185&#xD;&#xA;## sigma[4] 0.400 0.58  0.85 1.01   329&#xD;&#xA;## &#xD;&#xA;## Stan MCMC diagnostics:&#xD;&#xA;## n_eff / iter looks reasonable for all parameters&#xD;&#xA;## Rhats above 1.05 found for 1 parameters&#xD;&#xA;##  *Diagnose further to investigate why the chains have not mixed&#xD;&#xA;## 9 of 2000 iterations ended with a divergence (0.45%)&#xD;&#xA;##  *Try running with larger adapt_delta to remove the divergences&#xD;&#xA;## 0 of 2000 iterations saturated the maximum tree depth of 12 (0%)&#xD;&#xA;## Chain 1: E-FMI = 0.1879&#xD;&#xA;##  *E-FMI below 0.2 indicates you may need to reparameterize your model&#xD;&#xA;## &#xD;&#xA;## Samples were drawn using NUTS(diag_e) at Thu Apr 04 10:37:31 AM 2024.&#xD;&#xA;## For each parameter, n_eff is a crude measure of effective sample size,&#xD;&#xA;## and Rhat is the potential scale reduction factor on split MCMC chains&#xD;&#xA;## (at convergence, Rhat = 1)&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Pay no attention to the approximate significances of these smooths, I&amp;rsquo;m still not convinced that they are being calculated correctly in {&lt;code&gt;mvgam&lt;/code&gt;}. But notice how the AR terms are all close to &lt;code&gt;1&lt;/code&gt;, suggesting there is a lot of unmodelled temporal autocorrelation in the data. Has this impacted our inferences of distributed lag effects? The same prediction function can be used to visualize the distributed lag effects of &lt;code&gt;mintemp&lt;/code&gt;:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_dist_lags&lt;/span&gt;(mod3, data_all)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## `geom_smooth()` using method = &amp;#39;loess&amp;#39; and formula = &amp;#39;y ~ x&amp;#39;&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-39-1.png&#34; alt=&#34;Visualising nonlinear smooths in mgcv, mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;These estimates are now more nonlinear, probably because we have more power to detect effects by effectively capturing temporal dynamics with the latent AR processes:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mod3, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;trend&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-40-1.png&#34; alt=&#34;Visualising latent dynamic time series processes in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mod3, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;trend&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-40-2.png&#34; alt=&#34;Visualising latent dynamic time series processes in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mod3, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;trend&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-40-3.png&#34; alt=&#34;Visualising latent dynamic time series processes in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(mod3, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;trend&amp;#39;&lt;/span&gt;, series &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/index_files/figure-html/unnamed-chunk-40-4.png&#34; alt=&#34;Visualising latent dynamic time series processes in mvgam and R&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;We will leave it there for this post. Hopefully you find this useful at some point!&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;further-reading&#34;&gt;Further reading&#xA;  &lt;a href=&#34;#further-reading&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The following papers and resources offer useful material about Hierarchical Generalized Additive Models and distributed lag modeling&lt;/p&gt;&#xA;&lt;p&gt;Clark, N. J., Ernest, S. K. M., Senyondo, H., Simonis, J. L., White, E. P., Yennis, G. M., &amp;amp; Karunarathna, K. A. N. K. (2023). &#xA;&lt;a href=&#34;https://ecoevorxiv.org/repository/view/5143/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Multi-species dependencies improve forecasts of population dynamics in a long-term monitoring study&lt;/a&gt;. &lt;em&gt;Biorxiv&lt;/em&gt;, doi: &#xA;&lt;a href=&#34;https://doi.org/10.32942/X2TS34&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://doi.org/10.32942/X2TS34&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Gasparrini, A. (2014). &#xA;&lt;a href=&#34;https://onlinelibrary.wiley.com/doi/full/10.1002/sim.5963&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modeling exposure–lag–response associations with distributed lag non‐linear models&lt;/a&gt;. &lt;em&gt;Statistics in Medicine&lt;/em&gt;, 33(5), 881-899.&lt;/p&gt;&#xA;&lt;p&gt;Karunarathna, K. A. N. K., Wells, K., &amp;amp; Clark, N. J. (2024). &#xA;&lt;a href=&#34;https://www.sciencedirect.com/science/article/pii/S0304380024000371&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modelling nonlinear responses of a desert rodent species to environmental change with hierarchical dynamic generalized additive models&lt;/a&gt;. &lt;em&gt;Ecological Modelling&lt;/em&gt;, 490, 110648.&lt;/p&gt;&#xA;&lt;p&gt;Pedersen, E. J., Miller, D. L., Simpson, G. L., &amp;amp; Ross, N. (2019). &#xA;&lt;a href=&#34;https://peerj.com/articles/6876/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Hierarchical generalized additive models in ecology: an introduction with mgcv&lt;/a&gt;. &lt;em&gt;PeerJ&lt;/em&gt;, 7, e6876.&lt;/p&gt;&#xA;</description>
  </item>
<item>
  <title>Temporal autocorrelation in GAMs and the mvgam package</title>
  <link>https://ecogambler.netlify.app/blog/autocorrelated-gams/</link>
  <pubDate>Sun, 16 Jul 2023 00:00:00 +0000</pubDate>
<guid>https://ecogambler.netlify.app/blog/autocorrelated-gams/</guid>
  <description>&lt;style type=&#34;text/css&#34;&gt;&#xD;&#xA;details &gt; summary {&#xD;&#xA;  padding: 4px;&#xD;&#xA;  background-color: #8F2727;&#xD;&#xA;  color: white;&#xD;&#xA;  border: none;&#xD;&#xA;  box-shadow: 1px 1px 2px #bbbbbb;&#xD;&#xA;  cursor: pointer;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;details &gt; summary:hover {&#xD;&#xA;  background-color: #DCBCBC;&#xD;&#xA;  color: #8F2727;&#xD;&#xA;}&#xD;&#xA;&lt;/style&gt;&#xD;&#xA;&lt;p&gt;Generalized Additive Models (GAMs) are flexible tools that have found particular application in the analysis of time series data. In ecology, a host of recent papers and workshops have drawn attention to the power of GAMs for addressing complex ecological analyses. For example, &#xA;&lt;a href=&#34;https://fromthebottomoftheheap.net/about/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Gavin Simpson regularly hosts workshops on GAMs in R&lt;/a&gt;, and &#xA;&lt;a href=&#34;https://github.com/eric-pedersen/mgcv-esa-workshop&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;it is common to see GAMs on the workshop list for large international conferences in ecology and statistics&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;why-are-gams-useful-for-time-series-analysis&#34;&gt;Why are GAMs useful for time series analysis?&#xA;  &lt;a href=&#34;#why-are-gams-useful-for-time-series-analysis&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;There are several reasons we&amp;rsquo;d want to use a GAM, particularly one fitted in &#xA;&lt;a href=&#34;https://cran.r-project.org/web/packages/mgcv/index.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;the {&lt;code&gt;mgcv&lt;/code&gt;} R package&lt;/a&gt;, to analyse time series:&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;GAMs can be used to model non-linear trends in time series data&lt;/li&gt;&#xA;&lt;li&gt;GAMs can easily decompose time series into trend, seasonality and other components&lt;/li&gt;&#xA;&lt;li&gt;Smoothing splines can be used to identify periods of rapid historical change&lt;/li&gt;&#xA;&lt;li&gt;GAMs can incorporate complex random effects that are common in real time series&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Given the many ways that GAMs can model temporal data, it is tempting to extrapolate from their smooth functions to produce out of sample forecasts. Here I inspect how smoothing splines behave when extrapolating outside the training data to examine whether this can be useful in practice. I also discuss some of the pitfalls that tend to arise when trying to fit smoothing splines to temporally autocorrelated data. I then give a few solutions, most notably by making use of Bayesian Dynamic GAMs in the {&lt;code&gt;mvgam&lt;/code&gt;} R package.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;environment-setup&#34;&gt;Environment setup&#xA;  &lt;a href=&#34;#environment-setup&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;This tutorial relies on the following packages:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(mvgam)           &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Fit, interrogate and forecast DGAMs&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(dplyr)           &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Tidy and flexible data manipulation&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(marginaleffects) &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Compute conditional and marginal effects&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(ggplot2)         &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Flexible plotting&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;library&lt;/span&gt;(patchwork)       &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Combining ggplot objects&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;First I design a custom &lt;code&gt;ggplot2&lt;/code&gt; theme; feel free to ignore if you have your own plot preferences&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme_set&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme_classic&lt;/span&gt;(base_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;12&lt;/span&gt;, base_family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;serif&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;theme&lt;/span&gt;(axis.line.x.bottom &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;element_line&lt;/span&gt;(colour &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;black&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                                    size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                  axis.line.y.left &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;element_line&lt;/span&gt;(colour &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;black&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                                  size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;what-are-generalized-additive-models-gams&#34;&gt;What are Generalized Additive Models (GAMs)?&#xA;  &lt;a href=&#34;#what-are-generalized-additive-models-gams&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The content of this post relates to some concepts I introduced in a recent webinar for the &#xA;&lt;a href=&#34;https://ecoforecast.org/workshops/statistical-methods-seminar-series/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Ecological Forecasting Initiative&amp;rsquo;s and Ecological Society of America&amp;rsquo;s Statistical Methods Seminar Series&lt;/a&gt;. If you are completely unfamiliar with GAMs, it would be worth a watch to help you catch up on basic concepts.&lt;/p&gt;&#xA;&lt;center&gt;&#xD;&#xA;&lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34;https://www.youtube.com/embed/0zZopLlomsQ?si=E93rOr7326dLCIyq?start=1&#34; data-external = &#34;1&#34; title=&#34;YouTube video player&#34; frameborder=&#34;0&#34; allow=&#34;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&#34; allowfullscreen&gt;&lt;/iframe&gt;&#xD;&#xA;&lt;/center&gt;&#xD;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;wiggliness-and-autocorrelation&#34;&gt;Wiggliness and autocorrelation&#xA;  &lt;a href=&#34;#wiggliness-and-autocorrelation&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;A smoothing spline is composed of basis expansions whose coefficients, which must be estimated, control the functional relationship between a predictor variable and a conditional response. The size of the basis expansion limits the smooth’s potential complexity, with a larger set of basis functions allowing greater flexibility.&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;basis_weights.gif&#34; alt=&#34;How basis functions can be used to build a smoothing spline in a GAM&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;All we need to do once we&amp;rsquo;ve constructed the basis expansion is estimate the weights. This allows us to fit arbitrarily-shaped functions that can &lt;em&gt;learn&lt;/em&gt; nonlinear relationships from data&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;smooth_to_data.gif&#34; alt=&#34;Fitting a Generalized Additive Model to data in R&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;The smoothness of the spline is controlled by a &#xA;&lt;a href=&#34;https://m-clark.github.io/generalized-additive-models/technical.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;smoothing penalty&lt;/a&gt;, which penalizes functions that are excessively wiggly. The animation below illustrates this process, where the penalty &lt;code&gt;\(\rho\)&lt;/code&gt; is chosen to maximise some penalized log(likelihood):&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;penalty_spline.gif&#34; alt=&#34;How a smoothing penalty leads to nonlinear effects in GAMs&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;Here I use an exaggerated example to show how a smooth tries to wiggle excessively, leading to overfitting. This can be done by fixing the smoothing penalty &lt;code&gt;\(λ\)&lt;/code&gt; in a GAM fit with {&lt;code&gt;mgcv&lt;/code&gt;}&amp;rsquo;s &lt;code&gt;gam()&lt;/code&gt; function in R. By fitting models with increasingly relaxed smooths, with &lt;code&gt;\(λ\)&lt;/code&gt; values approaching zero, we produce increasingly wiggly fits that tend toward fully unpenalized functions.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;par&lt;/span&gt;(mfrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    mgp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;2.5&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    mai&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0.4&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.7&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.2&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.2&lt;/span&gt;)))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data&lt;/span&gt;(mcycle, package &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;MASS&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;m1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(accel &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(times, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;50&lt;/span&gt;), &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mcycle, method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;, sp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(m1, scheme &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, residuals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;, pch &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;16&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;L&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     ylab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;expression&lt;/span&gt;(lambda &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;), xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     shade.col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; scales&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;alpha&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#B97C7C&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.6&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;m2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(accel &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(times, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;50&lt;/span&gt;), &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mcycle, method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;, sp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(m2, scheme &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, residuals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;, pch &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;16&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;L&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     ylab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;expression&lt;/span&gt;(lambda &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;), xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     shade.col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; scales&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;alpha&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#B97C7C&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.6&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;m3 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(accel &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(times, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;50&lt;/span&gt;), &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mcycle, method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;, sp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.01&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(m3, scheme &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, residuals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;, pch &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;16&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;L&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     ylab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;expression&lt;/span&gt;(lambda &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.01&lt;/span&gt;), xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     shade.col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; scales&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;alpha&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#B97C7C&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.6&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;m4 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(accel &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(times, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;50&lt;/span&gt;), &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; mcycle, method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;, sp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.0000001&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(m4, scheme &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, residuals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;, pch &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;16&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;L&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     ylab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;expression&lt;/span&gt;(lambda &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.0000001&lt;/span&gt;), xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     shade.col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; scales&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;alpha&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#B97C7C&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.6&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-5-1.png&#34; alt=&#34;Wiggliness and penalized smooths in mgcv&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Notice how wiggly the function becomes in the last plot when &lt;code&gt;\(λ\)&lt;/code&gt; is very small, indicating that the function is overfitting to the in-sample training data. Incidentally, this behaviour mirrors what often happens when we try to model an autocorrelated time series with a smooth function of &lt;code&gt;time&lt;/code&gt;. Unfortunately, &#xA;&lt;a href=&#34;https://fromthebottomoftheheap.net/2011/07/21/smoothing-temporally-correlated-data/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;smoothing splines often try to wiggle excessively to capture autocorrelation in a time series&lt;/a&gt;. This makes fitting GAMs to time series challenging in some ways. It also leads to poor predictions and forecasts.&lt;/p&gt;&#xA;&lt;p&gt;To demonstrate how challenging it can be to work with temporally autocorrelated data in GAMs, I&amp;rsquo;ll load some time series of counts. The data are from the {&lt;code&gt;tscount&lt;/code&gt;} package and represent the umber of campylobacterosis cases (reported every 28 days) in the North of Québec in Canada from January 1990 to the end of October 2000.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Download the campy data from the tscount package&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;load&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;url&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;https://github.com/cran/tscount/raw/master/data/campy.RData&amp;#39;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Put data into a data.frame and visualize&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;dat &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data.frame&lt;/span&gt;(count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.vector&lt;/span&gt;(campy)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;%&amp;gt;%&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mutate&lt;/span&gt;(time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;dplyr&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;n&lt;/span&gt;())&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ggplot&lt;/span&gt;(dat, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;aes&lt;/span&gt;(time, count)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_point&lt;/span&gt;() &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_line&lt;/span&gt;()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Next I supply a few small convenience functions for inspecting model outputs.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Replicating mgcv::gam.check() but without the plots&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;small_check &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(model){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;cat&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;Basis dimension (k) checking results. Low p-value (k-index &amp;lt; 1) may\n&amp;#34;&lt;/span&gt;) &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;cat&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;indicate that k is too low, especially if edf is close to k\&amp;#39;.\n\n&amp;#34;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;printCoefmat&lt;/span&gt;(mgcv&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;k.check&lt;/span&gt;(model), digits &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Call marginaleffects::plot_predictions to inspect model fits&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;plot_fcs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(model, n_ahead &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  p &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_predictions&lt;/span&gt;(model, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   condition &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;list&lt;/span&gt;(time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(dat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; n_ahead)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;response&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   points &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;if&lt;/span&gt;(n_ahead &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    p &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; p &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_vline&lt;/span&gt;(xintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(dat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time), &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                 linetype &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;dashed&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  p&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;plot_links &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(model, n_ahead &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  p &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_predictions&lt;/span&gt;(model, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   condition &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;list&lt;/span&gt;(time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(dat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; n_ahead)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                   type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;link&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;ylab&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;linear predictor&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;if&lt;/span&gt;(n_ahead &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    p &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; p &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;      &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_vline&lt;/span&gt;(xintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(dat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time), &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                 linetype &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;dashed&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  p&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now onto some GAMs. My goal is to smooth over the temporal trend in the data and inspect the behaviour of the &lt;code&gt;gam.check()&lt;/code&gt; function from {&lt;code&gt;mgcv&lt;/code&gt;}. First I impose a restricted smooth of &lt;code&gt;time&lt;/code&gt; with a very small number of possible basis functions (using the default thin plate basis). For this and all subsequent models, I stick with a &lt;code&gt;poisson()&lt;/code&gt; observation model as this will make it easier to illustrate how the estimated smooth changes as we increase &lt;code&gt;k&lt;/code&gt;. After fitting the model, I then check basis dimension and plot the response-scaled predictions&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod1 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;6&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; dat,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;poisson&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;small_check&lt;/span&gt;(mod1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Basis dimension (k) checking results. Low p-value (k-index &amp;lt; 1) may&#xD;&#xA;## indicate that k is too low, especially if edf is close to k&amp;#39;.&#xD;&#xA;## &#xD;&#xA;##           k&amp;#39;  edf k-index p-value    &#xD;&#xA;## s(time) 5.00 4.81    0.61  &amp;lt;2e-16 ***&#xD;&#xA;## ---&#xD;&#xA;## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_fcs&lt;/span&gt;(mod1)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-8-1.png&#34; alt=&#34;Autocorrelated time series and GAMs in mgcv&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;These results strongly indicate that &lt;code&gt;k&lt;/code&gt; was set too low (i.e. the &lt;code&gt;k-index&lt;/code&gt; is well below &lt;code&gt;1&lt;/code&gt; and the estimated degrees of freedom is nearly as large as the maximum allowed degrees of freedom). The plot also suggests that the function is not flexible enough to capture the long-term (or short-term) variation in the observed counts. Now for a second model that allows for more possible complexity&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;23&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; dat,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;poisson&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;small_check&lt;/span&gt;(mod2)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Basis dimension (k) checking results. Low p-value (k-index &amp;lt; 1) may&#xD;&#xA;## indicate that k is too low, especially if edf is close to k&amp;#39;.&#xD;&#xA;## &#xD;&#xA;##           k&amp;#39;  edf k-index p-value    &#xD;&#xA;## s(time) 22.0 10.2    0.67  &amp;lt;2e-16 ***&#xD;&#xA;## ---&#xD;&#xA;## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_fcs&lt;/span&gt;(mod2)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-9-1.png&#34; alt=&#34;Autocorrelated time series and GAMs in mgcv&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;A similar result, with the checking function suggesting that we need to increase &lt;code&gt;k&lt;/code&gt; further if we want to capture the patterns that are left in the model residuals. Now for the whole hog, increasing &lt;code&gt;k&lt;/code&gt; to the maximum allowed basis dimension&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod3 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gam&lt;/span&gt;(count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;140&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; dat,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;poisson&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;REML&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;small_check&lt;/span&gt;(mod3)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Basis dimension (k) checking results. Low p-value (k-index &amp;lt; 1) may&#xD;&#xA;## indicate that k is too low, especially if edf is close to k&amp;#39;.&#xD;&#xA;## &#xD;&#xA;##          k&amp;#39; edf k-index p-value&#xD;&#xA;## s(time) 139  31    1.14    0.95&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_fcs&lt;/span&gt;(mod3)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-10-1.png&#34; alt=&#34;Autocorrelated time series and GAMs in mgcv&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Finally the check suggests the smooth was wiggly enough. But how does this wiggly smooth function behave if we want to extrapolate ahead? Here I predict ahead for &lt;code&gt;10&lt;/code&gt; timesteps from each of the above models to visualize extrapolation behaviours.&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_fcs&lt;/span&gt;(mod1, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-11-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_fcs&lt;/span&gt;(mod2, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-11-2.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_fcs&lt;/span&gt;(mod3, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-11-3.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;The functions give fairly different forecasts for each model because these penalized splines extrapolate linearly into the future (i.e. if the function wiggled downward toward the end of the training data, the forecast will continue linearly downward forever). This is easier visualized on the link scale&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_links&lt;/span&gt;(mod1, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-12-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_links&lt;/span&gt;(mod2, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-12-2.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_links&lt;/span&gt;(mod3, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-12-3.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;autoregressive-residuals-in-mgcv&#34;&gt;Autoregressive residuals in &lt;code&gt;mgcv&lt;/code&gt;&#xA;  &lt;a href=&#34;#autoregressive-residuals-in-mgcv&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;This behaviour is unwanted, for several reasons. First is the very obvious and unwanted extrapolation behaviour. Not only are these extrapolations typically unrealistic and ignorant of the types of behaviours that occurred within the training data, they are also extremely volatile. Simply by changing &lt;code&gt;k&lt;/code&gt; to respect the warnings from &lt;code&gt;gam.check()&lt;/code&gt;, we end up with very different ideas about plausible futures. The second reason we don&amp;rsquo;t want this is that, even if we are not interested in forecasting, chasing autocorrelation with increasingly wiggly smooths increases computational complexity and leads to identifiability issues. Plus there will no doubt be situations in which we cannot capture all of this autocorrelation no matter how wiggly we allow our smooths of &lt;code&gt;time&lt;/code&gt; to be.&lt;/p&gt;&#xA;&lt;p&gt;An obvious solution then is to try and include some sort of residual autocorrelation process in the model. For Gaussian responses, this is fairly straightfoward using the &lt;code&gt;gamm()&lt;/code&gt; function, which allows us to supply a correlation argument like those provided by &lt;code&gt;nlme::lme()&lt;/code&gt;. We can specify several different forms of stochastic ARMA models that will be used to model the residuals. But we are not using a Gaussian observation model here because our data are non-negative integers. There are other options we can use within &lt;code&gt;gamm()&lt;/code&gt; that make use of &lt;code&gt;MASS::glmmPQL()&lt;/code&gt; to fit the model, but this can be temperamental and give unsatisfactory results. Finally though, we have the option to use &lt;code&gt;bam()&lt;/code&gt; and supply a fixed AR1 coefficient, which will be applied to the working residuals. I&amp;rsquo;ll illustrate here by fixing the coefficient to &lt;code&gt;0.6&lt;/code&gt; as a simple example&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod4 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;bam&lt;/span&gt;(count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;s&lt;/span&gt;(time, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;140&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; dat,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;poisson&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            rho &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0.6&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            method &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;fREML&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            discrete &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;small_check&lt;/span&gt;(mod4)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## Basis dimension (k) checking results. Low p-value (k-index &amp;lt; 1) may&#xD;&#xA;## indicate that k is too low, especially if edf is close to k&amp;#39;.&#xD;&#xA;## &#xD;&#xA;##             k&amp;#39;    edf k-index p-value    &#xD;&#xA;## s(time) 139.00   5.95    0.63  &amp;lt;2e-16 ***&#xD;&#xA;## ---&#xD;&#xA;## Signif. codes:  0 &amp;#39;***&amp;#39; 0.001 &amp;#39;**&amp;#39; 0.01 &amp;#39;*&amp;#39; 0.05 &amp;#39;.&amp;#39; 0.1 &amp;#39; &amp;#39; 1&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_fcs&lt;/span&gt;(mod4)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-13-1.png&#34; alt=&#34;Autocorrelated time series and GAMs in mgcv with bam()&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;This leads to a much smoother estimate of the smooth, which is good news. We still have the warnings from &lt;code&gt;gam.check()&lt;/code&gt; unfortunately, but that is preferable to fitting a smooth that bends all over the place to try and capture the autocorrelation. The extrapolation behaviours are more sensible as well:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_fcs&lt;/span&gt;(mod4, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-14-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_links&lt;/span&gt;(mod4, &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-14-2.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;There are still several major downsides to this approach. We have to specify the AR1 coefficient, and if we are modeling several time series in a single joint model (which we very often want to do) we have to use the same AR1 dynamics for each series. We also have no way of incorporating more complex dynamics, such as AR2 or multivariate (VAR) processes. Missing values can cause small or very big problems (the residual AR1 model assumes there is a residual for every timepoint, but if you have missing observations these will be thrown out prior to model fitting). And finally, it is difficult to produce accurate forecasts from this model because our extrapolations do not incorporate the residual autoregressive process. To do so, we&amp;rsquo;d have to:&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;Extract working residuals from the fitted model&lt;/li&gt;&#xA;&lt;li&gt;Fit an AR1 model to these residuals using the &lt;code&gt;fixed&lt;/code&gt; argument in &lt;code&gt;arima()&lt;/code&gt; to ensure the coefficient is as we specified. This is necessary because we do not know what the variance parameter should be for the residual AR process (it is not returned anywhere in the &lt;code&gt;gam&lt;/code&gt; object&lt;/li&gt;&#xA;&lt;li&gt;Generate mean expectations (link scale) for the GAM model to cover the out-of-sample validation times&lt;/li&gt;&#xA;&lt;li&gt;Predict ahead for the residual AR model to cover the out-of-sample validation times&lt;/li&gt;&#xA;&lt;li&gt;Add the two together to generate the linear predictor values, take the inverse link function (using &lt;code&gt;exp()&lt;/code&gt; in this case for the log link) and then use them as the mean values for taking appropriate stochastic draws (using &lt;code&gt;rpois()&lt;/code&gt; in this case)&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;This process is tedious and error-prone. I won&amp;rsquo;t work through it here because there is a better way.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;dynamic-gams-using-mvgam&#34;&gt;Dynamic GAMs using &lt;code&gt;mvgam&lt;/code&gt;&#xA;  &lt;a href=&#34;#dynamic-gams-using-mvgam&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The &lt;code&gt;mvgam&lt;/code&gt; package was designed to solve these and many other problems we encounter when trying to model realistic time series, produce reliable inferences and generate accurate forecasts. There are many useful vignettes and case studies available (see &#xA;&lt;a href=&#34;https://nicholasjclark.github.io/mvgam/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;documentation on the package website&lt;/a&gt;). But I&amp;rsquo;ll quickly show how we can estimate nonlinear trends &lt;em&gt;and&lt;/em&gt; temporal autocorrelation in GAMs. This should allow us to do all the things we want with these models (i.e. calculate rates of change from the trend, interpolate over periods with missing data, produce accurate forecasts). This model uses quite a few of the advanced features of {&lt;code&gt;mvgam&lt;/code&gt;}, including:&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;A State-Space representation for a more efficient treatment of process and observation error&lt;/li&gt;&#xA;&lt;li&gt;A low-rank Gaussian Process (with squared exponential kernel) to capture the nonlinear long-term trend (which will forecast &lt;em&gt;much&lt;/em&gt; better than penalized smooths will)&lt;/li&gt;&#xA;&lt;li&gt;A latent AR1 model to capture unmodelled autocorrelation in the process (with fully estimated AR1 and variance parameters)&lt;/li&gt;&#xA;&lt;li&gt;An informed prior on the length scale parameter &lt;code&gt;\((\rho)\)&lt;/code&gt; of the Gaussian Process, which encodes our belief that the trend should be smooth&lt;/li&gt;&#xA;&lt;li&gt;Full Bayesian inference using &#xA;&lt;a href=&#34;https://mc-stan.org/docs/reference-manual/mcmc.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Hamiltonian Monte Carlo in &lt;code&gt;Stan&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mod5 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvgam&lt;/span&gt;(count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              trend_formula &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;gp&lt;/span&gt;(time, c &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;5&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;4&lt;/span&gt;, k &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                   scale &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;FALSE&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              trend_model &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;AR&lt;/span&gt;(),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;              priors &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;prior_string&lt;/span&gt;(prior &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;normal(16, 4)&amp;#39;&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                    class &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;rho_gp_trend(time)&amp;#39;&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            data &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; dat,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            family &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;poisson&lt;/span&gt;())&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The model fits quickly and encounters few issues. The GP has done an excellent job capturing the nonlinear trend&amp;hellip;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_links&lt;/span&gt;(mod5)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-17-1.png&#34; alt=&#34;Latent Gaussian Processes to capture autocorrelated time series in GAMs&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;&amp;hellip;while also producing sensible extrapolation behaviour:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_links&lt;/span&gt;(mod5, n_ahead &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-18-1.png&#34; alt=&#34;Latent Gaussian Processes to capture autocorrelated time series in GAMs&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;why-use-gaussian-processes-instead-of-splines&#34;&gt;Why use Gaussian Processes instead of splines?&#xA;  &lt;a href=&#34;#why-use-gaussian-processes-instead-of-splines&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;&amp;ldquo;&lt;em&gt;A Gaussian process defines a probability distribution over functions; in other words every sample from a Gaussian Process is an entire function from the covariate space X to the real-valued output space.&lt;/em&gt;&amp;rdquo; (Betancourt; &#xA;&lt;a href=&#34;https://betanalpha.github.io/assets/case_studies/gaussian_processes.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Robust Gaussian Process Modeling&lt;/a&gt;)&lt;/p&gt;&#xA;&lt;p&gt;In many time series analyses, we believe the power of past observations to explain current data is a function of &lt;em&gt;how long ago&lt;/em&gt; we observed those past observations. Gaussian Processes use covariance functions (often called &amp;lsquo;kernels&amp;rsquo;) that allow this to happen by specifying how correlations depend on the difference, in time, between observations. For our purposes we will rely on the squared exponential kernel, which depends on &lt;code&gt;\(\rho\)&lt;/code&gt; (often called the length scale parameter) to control how quickly correlations decay as a function of time. The functions also depend on a parameter &lt;code&gt;\(\alpha\)&lt;/code&gt;, which controls how much the term contributes to the linear predictor. Below we simulate from such a Gaussian Processes to get an idea of the kinds of functional shapes that can be produced as you vary the length scale  &lt;code&gt;\(\rho\)&lt;/code&gt;:&lt;/p&gt;&#xA;&lt;details&gt;&#xD;&#xA;  &lt;summary&gt;Click here if you would like to see the `R` code used to produce Gaussian Process simulations &lt;/summary&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# set a seed for reproducibility&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;set.seed&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;2222&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# simulate from a fairly large length-scale parameter&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;rho &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# set the alpha parameter to 1 for all simulations&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;alpha &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# simulate functions that span 50 time points&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;times &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;50&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# generate a sequence of prediction values&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;draw_seq &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;min&lt;/span&gt;(times), &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(times), length.out &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;100&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# construct the temporal covariance matrix&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Sigma &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; alpha^2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;*&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;-0.5&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;*&lt;/span&gt; ((&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;outer&lt;/span&gt;(draw_seq, draw_seq, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;-&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;/&lt;/span&gt; rho) ^ &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1e-12&lt;/span&gt;, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(draw_seq))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# draw a single realization from the GP distribution&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;gp_vals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; MASS&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvrnorm&lt;/span&gt;(n &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                         mu &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(draw_seq)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                         Sigma &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; Sigma)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# plot the single GP draw&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; draw_seq, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; gp_vals, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;, col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;darkred&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     ylab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;expression&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;f&lt;/span&gt;(Time)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time&amp;#39;&lt;/span&gt;, bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     ylim &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;-3.2&lt;/span&gt;,&lt;span style=&#34;color:#099&#34;&gt;3.2&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     main &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;expression&lt;/span&gt;(alpha&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt;&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;=&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;; &amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt;rho&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt;&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;=&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;~&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# overlay an additional 10 possible functions using different colours&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  draw &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; MASS&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mvrnorm&lt;/span&gt;(n &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, mu &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;length&lt;/span&gt;(draw_seq)),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                        Sigma &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; Sigma)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lines&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; draw_seq, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; draw, lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;3.5&lt;/span&gt;, col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;white&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lines&lt;/span&gt;(x &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; draw_seq, y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; draw,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;sample&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#DCBCBC&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#C79999&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#B97C7C&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#A25050&amp;#34;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                       &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#7C0000&amp;#34;&lt;/span&gt;), &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2.5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;box&lt;/span&gt;(bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;l&amp;#39;&lt;/span&gt;, lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-19-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;/details&gt;&#xD;&#xA;&lt;br&gt;&#xD;&#xA;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-20-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;This plot shows that the temporal autocorrelations have a long &amp;lsquo;memory&amp;rsquo;, i.e. they tend to change slowly over time. In contrast, let&amp;rsquo;s see what happens when we simulate from a GP with a shorter length scale parameter (the same code as above was used, except the length scale was changed to 4)&#xA;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-21-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&lt;/p&gt;&#xA;&lt;p&gt;These functions are much &amp;lsquo;wigglier&amp;rsquo; and can be useful for capturing temporal dynamics with short-term &amp;lsquo;memory&amp;rsquo;. A &lt;strong&gt;big advantage&lt;/strong&gt; of Gaussian Processes is that they can easily handle data that are irregularly sampled, much like splines can (and in contrast to autoregressive processes like we&amp;rsquo;ve been using so far). But although Gaussian Processes may look similar to splines in the functions they return, they are fundamentally different. In particular, a spline has local knowledge, meaning it has no principled way of understanding how the function itself is evolving across time. But a GP directly models how the function changes over time, which means it is better able to generate out-of-sample predictions.&lt;/p&gt;&#xA;&lt;p&gt;Another big advantage of Gaussian Processes is that their parameters are more directly interpretable than are spline parameters. For instance, the length scale parameter &lt;code&gt;\(\rho\)&lt;/code&gt; is related to the stationarity (or stability) of the system. By supplying a prior that pulled this parameter towards &lt;em&gt;larger&lt;/em&gt; values, our Bayesian model directly captured our belief that the trend should change smoothly over time (i.e. a long &amp;ldquo;memory&amp;rdquo;) and that any unmodelled short-term autocorrelation should be captured by the AR1 process. &#xA;&lt;a href=&#34;https://stats.stackexchange.com/questions/515873/how-to-account-for-temporal-autocorrelation-in-a-hierarchical-generalized-additi&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;By contrast, encoding this sort of information when using splines is incredibly difficult&lt;/a&gt;.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h3 id=&#34;back-to-interrogating-our-dynamic-model&#34;&gt;Back to interrogating our dynamic model&#xA;  &lt;a href=&#34;#back-to-interrogating-our-dynamic-model&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h3&gt;&#xA;&lt;p&gt;We can plot how covariance is expected to change over increasing distances in time to understand the long-range &amp;ldquo;memory&amp;rdquo; of the Gaussian Process. Those of you that have worked with variograms or semi-variograms before when analysing spatial data will be used to visualizing how semivariance decays over distance. Here we will visualize how covariance decays over time distances (i.e. how far apart in time to we need to be before our estimate from the GP no longer depends on another?). We can define a few helper functions to generate these plots, which will accept posterior estimates of GP parameters from a fitted &lt;code&gt;mvgam&lt;/code&gt; object, compute the estimted temporal covariance kernels, calculate posterior quantiles and then plot them:&lt;/p&gt;&#xA;&lt;details&gt;&#xD;&#xA;  &lt;summary&gt;Click here if you would like to see the `R` function `plot_kernels`, used to plot GP kernels &lt;/summary&gt;&#xD;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Compute the covariance kernel for a given draw&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# of GP alpha and rho parameters&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;quad_kernel &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(rho, alpha, times){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  covs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; alpha ^ &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;*&lt;/span&gt; &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;-0.5&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;*&lt;/span&gt; ((times &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;/&lt;/span&gt; rho) ^ &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;return&lt;/span&gt;(covs)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Compute kernels for each posterior draw&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;plot_kernels &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(gp_ests, max_time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;50&lt;/span&gt;){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# set up an empty matrix to store the kernel estimates &lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# for each posterior draw&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  draw_seq &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, max_time, length.out &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;100&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  kernels &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NA&lt;/span&gt;, nrow &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NROW&lt;/span&gt;(gp_ests), ncol &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;100&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# use a for-loop to estimate the kernel for each draw using&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# our custom quad_kernel() function&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;for&lt;/span&gt;(i &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;in&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NROW&lt;/span&gt;(gp_ests)){&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    kernels[i,] &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;quad_kernel&lt;/span&gt;(rho &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; gp_ests&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;`rho_gp_trend_time_`[i],&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               alpha &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; gp_ests&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;`alpha_gp_trend_time_`[i],&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                               times &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; draw_seq)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Calculate posterior empirical quantiles of the kernels&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  probs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0.05&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.2&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.5&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.8&lt;/span&gt;, &lt;span style=&#34;color:#099&#34;&gt;0.95&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  cred &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;sapply&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;NCOL&lt;/span&gt;(kernels),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;function&lt;/span&gt;(n) &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;quantile&lt;/span&gt;(kernels[,n],&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                      probs &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; probs))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#998;font-style:italic&#34;&gt;# Plot the kernel uncertainty estimates&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  pred_vals &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; draw_seq&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;, xlim &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, max_time), ylim &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(cred)), type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;n&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       xlab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Time difference&amp;#39;&lt;/span&gt;, ylab &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;Covariance&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;L&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;box&lt;/span&gt;(bty &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;L&amp;#39;&lt;/span&gt;, lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;polygon&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(pred_vals, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rev&lt;/span&gt;(pred_vals)), &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(cred[1,], &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rev&lt;/span&gt;(cred[5,])),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#DCBCBC&amp;#34;&lt;/span&gt;, border &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NA&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;polygon&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(pred_vals, &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rev&lt;/span&gt;(pred_vals)), &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(cred[2,], &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;rev&lt;/span&gt;(cred[4,])),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;          col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#B97C7C&amp;#34;&lt;/span&gt;, border &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;NA&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;lines&lt;/span&gt;(pred_vals, cred[3,], col &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#34;#7C0000&amp;#34;&lt;/span&gt;, lwd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;2.5&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;&#xD;&#xA;&lt;br&gt;&#xD;&#xA;&lt;p&gt;Extract posterior estimates of the GP parameters using the &lt;code&gt;as.data.frame&lt;/code&gt; function that we&amp;rsquo;ve been using previously. You can then plot the posterior kernel estimates for model 5 to visualize how temporal error covariance is estimated to change as two time points are further apart. To do this, all we need to supply is the posterior estimates for the GP parameters in the form of a &lt;code&gt;data.frame&lt;/code&gt;:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;gp_ests &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;as.data.frame&lt;/span&gt;(mod5, variable &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;rho_gp&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                                            &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;alpha_gp&amp;#39;&lt;/span&gt;),&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                         regex &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_kernels&lt;/span&gt;(gp_ests &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; gp_ests, max_time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;30&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/Plot mvgam GP covariance kernels-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;Here we can see how correlations between timepoints decay smoothly as we move further apart in time.&#xD;&#xA;&lt;p&gt;This smooth function is not that complex but works well because we have adequately captured temporal autocorrelation using the latent AR1 process. Estimates of the AR1 parameters come with full uncertainties:&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;mcmc_plot&lt;/span&gt;(mod5, variable &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;ar1&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;sigma&amp;#39;&lt;/span&gt;), regex &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;TRUE&lt;/span&gt;, type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;areas&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-22-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;Plotting the hindcasts and forecasts won&amp;rsquo;t work directly with {&lt;code&gt;marginaleffects&lt;/code&gt;} as we want to also include the AR1 process. But this is easy to do with {&lt;code&gt;mvgam&lt;/code&gt;} functionality&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;hc &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;hindcast&lt;/span&gt;(mod5)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(hc)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-23-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## No non-missing values in test_observations; cannot calculate forecast score&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;fc &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;forecast&lt;/span&gt;(mod5, newdata &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;data.frame&lt;/span&gt;(time &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(dat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;1&lt;/span&gt;)&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;:&lt;/span&gt;(&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;max&lt;/span&gt;(dat&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;$&lt;/span&gt;time) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;10&lt;/span&gt;)))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot&lt;/span&gt;(fc)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-24-1.png&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;## No non-missing values in test_observations; cannot calculate forecast score&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If we wanted to ask targeted questions about the nonlinear trend, we could do this readily. For example, here is the 1st derivative (i.e. the marginal effect) of time, which we can use to ask when the trend was changing most rapidly (i.e. at which time points was the derivative &lt;em&gt;furthest&lt;/em&gt; from zero?)&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;plot_slopes&lt;/span&gt;(mod5, variables &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;time&amp;#39;&lt;/span&gt;, condition &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;time&amp;#39;&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;link&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;labs&lt;/span&gt;(y &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;First derivative (slope) of linear predictor&amp;#39;&lt;/span&gt;) &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;+&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;  &lt;span style=&#34;color:#900;font-weight:bold&#34;&gt;geom_hline&lt;/span&gt;(yintercept &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#099&#34;&gt;0&lt;/span&gt;, linetype &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#d14&#34;&gt;&amp;#39;dashed&amp;#39;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;img src=&#34;https://ecogambler.netlify.app/blog/autocorrelated-gams/index_files/figure-html/unnamed-chunk-25-1.png&#34; alt=&#34;Calculating rates of change from Dynamic GAMs fit to time series in mgcv and mvgam&#34; width=&#34;60%&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&#xD;&#xA;&lt;p&gt;There are many more options to capture temporal dynamics and nonlinear effects using dynamic GAMs. For example, my blog post on &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/blog/distributed-lags-mgcv/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;distributed lag nonlinear models using mgcv and mvgam&lt;/a&gt; gives some tips on how to fit lagged covariate effects in GAMs. &#xA;&lt;a href=&#34;https://ecogambler.netlify.app/talk/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;My research seminar and webinar page&lt;/a&gt; also has some good resources and modeling ideas for time series analyses. But we&amp;rsquo;ll leave those for later posts&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;h2 id=&#34;further-reading&#34;&gt;Further reading&#xA;  &lt;a href=&#34;#further-reading&#34;&gt;&lt;svg class=&#34;anchor-symbol&#34; aria-hidden=&#34;true&#34; height=&#34;26&#34; width=&#34;26&#34; viewBox=&#34;0 0 22 22&#34; xmlns=&#34;http://www.w3.org/2000/svg&#34;&gt;&#xA;      &lt;path d=&#34;M0 0h24v24H0z&#34; fill=&#34;currentColor&#34;&gt;&lt;/path&gt;&#xA;      &lt;path d=&#34;M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z&#34;&gt;&lt;/path&gt;&#xA;    &lt;/svg&gt;&lt;/a&gt;&#xA;&lt;/h2&gt;&#xA;&lt;p&gt;The following papers and resources offer useful material about modeling time series with Generalized Additive Models&lt;/p&gt;&#xA;&lt;p&gt;Clark, N. J., Ernest, S. K. M., Senyondo, H., Simonis, J. L., White, E. P., Yennis, G. M., &amp;amp; Karunarathna, K. A. N. K. (2023). &#xA;&lt;a href=&#34;https://ecoevorxiv.org/repository/view/5143/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Multi-species dependencies improve forecasts of population dynamics in a long-term monitoring study&lt;/a&gt;. &lt;em&gt;Biorxiv&lt;/em&gt;, doi: &#xA;&lt;a href=&#34;https://doi.org/10.32942/X2TS34&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://doi.org/10.32942/X2TS34&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;Gasparrini, A. (2014). &#xA;&lt;a href=&#34;https://onlinelibrary.wiley.com/doi/full/10.1002/sim.5963&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modeling exposure–lag–response associations with distributed lag non‐linear models&lt;/a&gt;. &lt;em&gt;Statistics in Medicine&lt;/em&gt;, 33(5), 881-899.&lt;/p&gt;&#xA;&lt;p&gt;Pedersen, E. J., Miller, D. L., Simpson, G. L., &amp;amp; Ross, N. (2019). &#xA;&lt;a href=&#34;https://peerj.com/articles/6876/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Hierarchical generalized additive models in ecology: an introduction with mgcv&lt;/a&gt;. &lt;em&gt;PeerJ&lt;/em&gt;, 7, e6876.&lt;/p&gt;&#xA;&lt;p&gt;Simpson, G. L. (2018). &#xA;&lt;a href=&#34;https://www.frontiersin.org/articles/10.3389/fevo.2018.00149/full&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Modelling palaeoecological time series using generalised additive models&lt;/a&gt;. &lt;em&gt;Frontiers in Ecology and Evolution&lt;/em&gt;, 6, 149.&lt;/p&gt;&#xA;</description>
  </item>
</channel>
  </rss>
